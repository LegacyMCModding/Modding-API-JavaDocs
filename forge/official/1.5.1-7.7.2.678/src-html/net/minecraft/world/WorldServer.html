<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
</head>
<body>
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span>package net.minecraft.world;<a name="line.1"></a>
<span class="sourceLineNo">002</span><a name="line.2"></a>
<span class="sourceLineNo">003</span>import cpw.mods.fml.relauncher.Side;<a name="line.3"></a>
<span class="sourceLineNo">004</span>import cpw.mods.fml.relauncher.SideOnly;<a name="line.4"></a>
<span class="sourceLineNo">005</span><a name="line.5"></a>
<span class="sourceLineNo">006</span>import java.io.File;<a name="line.6"></a>
<span class="sourceLineNo">007</span>import java.util.ArrayList;<a name="line.7"></a>
<span class="sourceLineNo">008</span>import java.util.HashSet;<a name="line.8"></a>
<span class="sourceLineNo">009</span>import java.util.Iterator;<a name="line.9"></a>
<span class="sourceLineNo">010</span>import java.util.List;<a name="line.10"></a>
<span class="sourceLineNo">011</span>import java.util.Random;<a name="line.11"></a>
<span class="sourceLineNo">012</span>import java.util.Set;<a name="line.12"></a>
<span class="sourceLineNo">013</span>import java.util.TreeSet;<a name="line.13"></a>
<span class="sourceLineNo">014</span>import net.minecraft.block.Block;<a name="line.14"></a>
<span class="sourceLineNo">015</span>import net.minecraft.block.BlockEventData;<a name="line.15"></a>
<span class="sourceLineNo">016</span>import net.minecraft.crash.CrashReport;<a name="line.16"></a>
<span class="sourceLineNo">017</span>import net.minecraft.crash.CrashReportCategory;<a name="line.17"></a>
<span class="sourceLineNo">018</span>import net.minecraft.entity.Entity;<a name="line.18"></a>
<span class="sourceLineNo">019</span>import net.minecraft.entity.EntityTracker;<a name="line.19"></a>
<span class="sourceLineNo">020</span>import net.minecraft.entity.EnumCreatureType;<a name="line.20"></a>
<span class="sourceLineNo">021</span>import net.minecraft.entity.INpc;<a name="line.21"></a>
<span class="sourceLineNo">022</span>import net.minecraft.entity.effect.EntityLightningBolt;<a name="line.22"></a>
<span class="sourceLineNo">023</span>import net.minecraft.entity.passive.EntityAnimal;<a name="line.23"></a>
<span class="sourceLineNo">024</span>import net.minecraft.entity.passive.EntityWaterMob;<a name="line.24"></a>
<span class="sourceLineNo">025</span>import net.minecraft.entity.player.EntityPlayer;<a name="line.25"></a>
<span class="sourceLineNo">026</span>import net.minecraft.entity.player.EntityPlayerMP;<a name="line.26"></a>
<span class="sourceLineNo">027</span>import net.minecraft.item.Item;<a name="line.27"></a>
<span class="sourceLineNo">028</span>import net.minecraft.logging.ILogAgent;<a name="line.28"></a>
<span class="sourceLineNo">029</span>import net.minecraft.network.packet.Packet38EntityStatus;<a name="line.29"></a>
<span class="sourceLineNo">030</span>import net.minecraft.network.packet.Packet54PlayNoteBlock;<a name="line.30"></a>
<span class="sourceLineNo">031</span>import net.minecraft.network.packet.Packet60Explosion;<a name="line.31"></a>
<span class="sourceLineNo">032</span>import net.minecraft.network.packet.Packet70GameEvent;<a name="line.32"></a>
<span class="sourceLineNo">033</span>import net.minecraft.network.packet.Packet71Weather;<a name="line.33"></a>
<span class="sourceLineNo">034</span>import net.minecraft.profiler.Profiler;<a name="line.34"></a>
<span class="sourceLineNo">035</span>import net.minecraft.scoreboard.ScoreboardSaveData;<a name="line.35"></a>
<span class="sourceLineNo">036</span>import net.minecraft.scoreboard.ServerScoreboard;<a name="line.36"></a>
<span class="sourceLineNo">037</span>import net.minecraft.server.MinecraftServer;<a name="line.37"></a>
<span class="sourceLineNo">038</span>import net.minecraft.server.management.PlayerManager;<a name="line.38"></a>
<span class="sourceLineNo">039</span>import net.minecraft.tileentity.TileEntity;<a name="line.39"></a>
<span class="sourceLineNo">040</span>import net.minecraft.util.ChunkCoordinates;<a name="line.40"></a>
<span class="sourceLineNo">041</span>import net.minecraft.util.IProgressUpdate;<a name="line.41"></a>
<span class="sourceLineNo">042</span>import net.minecraft.util.IntHashMap;<a name="line.42"></a>
<span class="sourceLineNo">043</span>import net.minecraft.util.ReportedException;<a name="line.43"></a>
<span class="sourceLineNo">044</span>import net.minecraft.util.Vec3;<a name="line.44"></a>
<span class="sourceLineNo">045</span>import net.minecraft.util.WeightedRandom;<a name="line.45"></a>
<span class="sourceLineNo">046</span>import net.minecraft.util.WeightedRandomChestContent;<a name="line.46"></a>
<span class="sourceLineNo">047</span>import net.minecraft.world.biome.BiomeGenBase;<a name="line.47"></a>
<span class="sourceLineNo">048</span>import net.minecraft.world.biome.SpawnListEntry;<a name="line.48"></a>
<span class="sourceLineNo">049</span>import net.minecraft.world.biome.WorldChunkManager;<a name="line.49"></a>
<span class="sourceLineNo">050</span>import net.minecraft.world.chunk.Chunk;<a name="line.50"></a>
<span class="sourceLineNo">051</span>import net.minecraft.world.chunk.IChunkProvider;<a name="line.51"></a>
<span class="sourceLineNo">052</span>import net.minecraft.world.chunk.storage.AnvilChunkLoader;<a name="line.52"></a>
<span class="sourceLineNo">053</span>import net.minecraft.world.chunk.storage.ExtendedBlockStorage;<a name="line.53"></a>
<span class="sourceLineNo">054</span>import net.minecraft.world.chunk.storage.IChunkLoader;<a name="line.54"></a>
<span class="sourceLineNo">055</span>import net.minecraft.world.gen.ChunkProviderServer;<a name="line.55"></a>
<span class="sourceLineNo">056</span>import net.minecraft.world.gen.feature.WorldGeneratorBonusChest;<a name="line.56"></a>
<span class="sourceLineNo">057</span>import net.minecraft.world.storage.ISaveHandler;<a name="line.57"></a>
<span class="sourceLineNo">058</span><a name="line.58"></a>
<span class="sourceLineNo">059</span>import net.minecraftforge.common.ChestGenHooks;<a name="line.59"></a>
<span class="sourceLineNo">060</span>import static net.minecraftforge.common.ChestGenHooks.*;<a name="line.60"></a>
<span class="sourceLineNo">061</span>import net.minecraftforge.common.DimensionManager;<a name="line.61"></a>
<span class="sourceLineNo">062</span>import net.minecraftforge.common.MinecraftForge;<a name="line.62"></a>
<span class="sourceLineNo">063</span>import net.minecraftforge.event.ForgeEventFactory;<a name="line.63"></a>
<span class="sourceLineNo">064</span>import net.minecraftforge.event.world.WorldEvent;<a name="line.64"></a>
<span class="sourceLineNo">065</span><a name="line.65"></a>
<span class="sourceLineNo">066</span>public class WorldServer extends World<a name="line.66"></a>
<span class="sourceLineNo">067</span>{<a name="line.67"></a>
<span class="sourceLineNo">068</span>    private final MinecraftServer mcServer;<a name="line.68"></a>
<span class="sourceLineNo">069</span>    private final EntityTracker theEntityTracker;<a name="line.69"></a>
<span class="sourceLineNo">070</span>    private final PlayerManager thePlayerManager;<a name="line.70"></a>
<span class="sourceLineNo">071</span>    private Set field_73064_N;<a name="line.71"></a>
<span class="sourceLineNo">072</span><a name="line.72"></a>
<span class="sourceLineNo">073</span>    /** All work to do in future ticks. */<a name="line.73"></a>
<span class="sourceLineNo">074</span>    private TreeSet pendingTickListEntries;<a name="line.74"></a>
<span class="sourceLineNo">075</span>    public ChunkProviderServer theChunkProviderServer;<a name="line.75"></a>
<span class="sourceLineNo">076</span><a name="line.76"></a>
<span class="sourceLineNo">077</span>    /** set by CommandServerSave{all,Off,On} */<a name="line.77"></a>
<span class="sourceLineNo">078</span>    public boolean canNotSave;<a name="line.78"></a>
<span class="sourceLineNo">079</span><a name="line.79"></a>
<span class="sourceLineNo">080</span>    /** is false if there are no players */<a name="line.80"></a>
<span class="sourceLineNo">081</span>    public boolean allPlayersSleeping;<a name="line.81"></a>
<span class="sourceLineNo">082</span>    private int updateEntityTick = 0;<a name="line.82"></a>
<span class="sourceLineNo">083</span>    private final Teleporter field_85177_Q;<a name="line.83"></a>
<span class="sourceLineNo">084</span><a name="line.84"></a>
<span class="sourceLineNo">085</span>    /**<a name="line.85"></a>
<span class="sourceLineNo">086</span>     * Double buffer of ServerBlockEventList[] for holding pending BlockEventData's<a name="line.86"></a>
<span class="sourceLineNo">087</span>     */<a name="line.87"></a>
<span class="sourceLineNo">088</span>    private ServerBlockEventList[] blockEventCache = new ServerBlockEventList[] {new ServerBlockEventList((ServerBlockEvent)null), new ServerBlockEventList((ServerBlockEvent)null)};<a name="line.88"></a>
<span class="sourceLineNo">089</span><a name="line.89"></a>
<span class="sourceLineNo">090</span>    /**<a name="line.90"></a>
<span class="sourceLineNo">091</span>     * The index into the blockEventCache; either 0, or 1, toggled in sendBlockEventPackets  where all BlockEvent are<a name="line.91"></a>
<span class="sourceLineNo">092</span>     * applied locally and send to clients.<a name="line.92"></a>
<span class="sourceLineNo">093</span>     */<a name="line.93"></a>
<span class="sourceLineNo">094</span>    private int blockEventCacheIndex = 0;<a name="line.94"></a>
<span class="sourceLineNo">095</span>    public static final WeightedRandomChestContent[] bonusChestContent = new WeightedRandomChestContent[] {new WeightedRandomChestContent(Item.stick.itemID, 0, 1, 3, 10), new WeightedRandomChestContent(Block.planks.blockID, 0, 1, 3, 10), new WeightedRandomChestContent(Block.wood.blockID, 0, 1, 3, 10), new WeightedRandomChestContent(Item.axeStone.itemID, 0, 1, 1, 3), new WeightedRandomChestContent(Item.axeWood.itemID, 0, 1, 1, 5), new WeightedRandomChestContent(Item.pickaxeStone.itemID, 0, 1, 1, 3), new WeightedRandomChestContent(Item.pickaxeWood.itemID, 0, 1, 1, 5), new WeightedRandomChestContent(Item.appleRed.itemID, 0, 2, 3, 5), new WeightedRandomChestContent(Item.bread.itemID, 0, 2, 3, 3)};<a name="line.95"></a>
<span class="sourceLineNo">096</span>    private ArrayList field_94579_S = new ArrayList();<a name="line.96"></a>
<span class="sourceLineNo">097</span><a name="line.97"></a>
<span class="sourceLineNo">098</span>    /** An IntHashMap of entity IDs (integers) to their Entity objects. */<a name="line.98"></a>
<span class="sourceLineNo">099</span>    private IntHashMap entityIdMap;<a name="line.99"></a>
<span class="sourceLineNo">100</span><a name="line.100"></a>
<span class="sourceLineNo">101</span>    /** Stores the recently processed (lighting) chunks */<a name="line.101"></a>
<span class="sourceLineNo">102</span>    protected Set&lt;ChunkCoordIntPair&gt; doneChunks = new HashSet&lt;ChunkCoordIntPair&gt;();<a name="line.102"></a>
<span class="sourceLineNo">103</span>    public List&lt;Teleporter&gt; customTeleporters = new ArrayList&lt;Teleporter&gt;();<a name="line.103"></a>
<span class="sourceLineNo">104</span><a name="line.104"></a>
<span class="sourceLineNo">105</span>    public WorldServer(MinecraftServer par1MinecraftServer, ISaveHandler par2ISaveHandler, String par3Str, int par4, WorldSettings par5WorldSettings, Profiler par6Profiler, ILogAgent par7ILogAgent)<a name="line.105"></a>
<span class="sourceLineNo">106</span>    {<a name="line.106"></a>
<span class="sourceLineNo">107</span>        super(par2ISaveHandler, par3Str, par5WorldSettings, WorldProvider.getProviderForDimension(par4), par6Profiler, par7ILogAgent);<a name="line.107"></a>
<span class="sourceLineNo">108</span>        this.mcServer = par1MinecraftServer;<a name="line.108"></a>
<span class="sourceLineNo">109</span>        this.theEntityTracker = new EntityTracker(this);<a name="line.109"></a>
<span class="sourceLineNo">110</span>        this.thePlayerManager = new PlayerManager(this, par1MinecraftServer.getConfigurationManager().getViewDistance());<a name="line.110"></a>
<span class="sourceLineNo">111</span><a name="line.111"></a>
<span class="sourceLineNo">112</span>        if (this.entityIdMap == null)<a name="line.112"></a>
<span class="sourceLineNo">113</span>        {<a name="line.113"></a>
<span class="sourceLineNo">114</span>            this.entityIdMap = new IntHashMap();<a name="line.114"></a>
<span class="sourceLineNo">115</span>        }<a name="line.115"></a>
<span class="sourceLineNo">116</span><a name="line.116"></a>
<span class="sourceLineNo">117</span>        if (this.field_73064_N == null)<a name="line.117"></a>
<span class="sourceLineNo">118</span>        {<a name="line.118"></a>
<span class="sourceLineNo">119</span>            this.field_73064_N = new HashSet();<a name="line.119"></a>
<span class="sourceLineNo">120</span>        }<a name="line.120"></a>
<span class="sourceLineNo">121</span><a name="line.121"></a>
<span class="sourceLineNo">122</span>        if (this.pendingTickListEntries == null)<a name="line.122"></a>
<span class="sourceLineNo">123</span>        {<a name="line.123"></a>
<span class="sourceLineNo">124</span>            this.pendingTickListEntries = new TreeSet();<a name="line.124"></a>
<span class="sourceLineNo">125</span>        }<a name="line.125"></a>
<span class="sourceLineNo">126</span><a name="line.126"></a>
<span class="sourceLineNo">127</span>        this.field_85177_Q = new Teleporter(this);<a name="line.127"></a>
<span class="sourceLineNo">128</span>        this.worldScoreboard = new ServerScoreboard(par1MinecraftServer);<a name="line.128"></a>
<span class="sourceLineNo">129</span>        ScoreboardSaveData scoreboardsavedata = (ScoreboardSaveData)this.mapStorage.loadData(ScoreboardSaveData.class, "scoreboard");<a name="line.129"></a>
<span class="sourceLineNo">130</span><a name="line.130"></a>
<span class="sourceLineNo">131</span>        if (scoreboardsavedata == null)<a name="line.131"></a>
<span class="sourceLineNo">132</span>        {<a name="line.132"></a>
<span class="sourceLineNo">133</span>            scoreboardsavedata = new ScoreboardSaveData();<a name="line.133"></a>
<span class="sourceLineNo">134</span>            this.mapStorage.setData("scoreboard", scoreboardsavedata);<a name="line.134"></a>
<span class="sourceLineNo">135</span>        }<a name="line.135"></a>
<span class="sourceLineNo">136</span><a name="line.136"></a>
<span class="sourceLineNo">137</span>        if (!(this instanceof WorldServerMulti)) //Forge: We fix the global mapStorage, which causes us to share scoreboards early. So don't associate the save data with the temporary scoreboard<a name="line.137"></a>
<span class="sourceLineNo">138</span>        {<a name="line.138"></a>
<span class="sourceLineNo">139</span>            scoreboardsavedata.func_96499_a(this.worldScoreboard);<a name="line.139"></a>
<span class="sourceLineNo">140</span>        }<a name="line.140"></a>
<span class="sourceLineNo">141</span>        ((ServerScoreboard)this.worldScoreboard).func_96547_a(scoreboardsavedata);<a name="line.141"></a>
<span class="sourceLineNo">142</span>        DimensionManager.setWorld(par4, this);<a name="line.142"></a>
<span class="sourceLineNo">143</span>    }<a name="line.143"></a>
<span class="sourceLineNo">144</span><a name="line.144"></a>
<span class="sourceLineNo">145</span>    /**<a name="line.145"></a>
<span class="sourceLineNo">146</span>     * Runs a single tick for the world<a name="line.146"></a>
<span class="sourceLineNo">147</span>     */<a name="line.147"></a>
<span class="sourceLineNo">148</span>    public void tick()<a name="line.148"></a>
<span class="sourceLineNo">149</span>    {<a name="line.149"></a>
<span class="sourceLineNo">150</span>        super.tick();<a name="line.150"></a>
<span class="sourceLineNo">151</span><a name="line.151"></a>
<span class="sourceLineNo">152</span>        if (this.getWorldInfo().isHardcoreModeEnabled() &amp;&amp; this.difficultySetting &lt; 3)<a name="line.152"></a>
<span class="sourceLineNo">153</span>        {<a name="line.153"></a>
<span class="sourceLineNo">154</span>            this.difficultySetting = 3;<a name="line.154"></a>
<span class="sourceLineNo">155</span>        }<a name="line.155"></a>
<span class="sourceLineNo">156</span><a name="line.156"></a>
<span class="sourceLineNo">157</span>        this.provider.worldChunkMgr.cleanupCache();<a name="line.157"></a>
<span class="sourceLineNo">158</span><a name="line.158"></a>
<span class="sourceLineNo">159</span>        if (this.areAllPlayersAsleep())<a name="line.159"></a>
<span class="sourceLineNo">160</span>        {<a name="line.160"></a>
<span class="sourceLineNo">161</span>            boolean flag = false;<a name="line.161"></a>
<span class="sourceLineNo">162</span><a name="line.162"></a>
<span class="sourceLineNo">163</span>            if (this.spawnHostileMobs &amp;&amp; this.difficultySetting &gt;= 1)<a name="line.163"></a>
<span class="sourceLineNo">164</span>            {<a name="line.164"></a>
<span class="sourceLineNo">165</span>                ;<a name="line.165"></a>
<span class="sourceLineNo">166</span>            }<a name="line.166"></a>
<span class="sourceLineNo">167</span><a name="line.167"></a>
<span class="sourceLineNo">168</span>            if (!flag)<a name="line.168"></a>
<span class="sourceLineNo">169</span>            {<a name="line.169"></a>
<span class="sourceLineNo">170</span>                long i = this.worldInfo.getWorldTime() + 24000L;<a name="line.170"></a>
<span class="sourceLineNo">171</span>                this.worldInfo.setWorldTime(i - i % 24000L);<a name="line.171"></a>
<span class="sourceLineNo">172</span>                this.wakeAllPlayers();<a name="line.172"></a>
<span class="sourceLineNo">173</span>            }<a name="line.173"></a>
<span class="sourceLineNo">174</span>        }<a name="line.174"></a>
<span class="sourceLineNo">175</span><a name="line.175"></a>
<span class="sourceLineNo">176</span>        this.theProfiler.startSection("mobSpawner");<a name="line.176"></a>
<span class="sourceLineNo">177</span><a name="line.177"></a>
<span class="sourceLineNo">178</span>        if (this.getGameRules().getGameRuleBooleanValue("doMobSpawning"))<a name="line.178"></a>
<span class="sourceLineNo">179</span>        {<a name="line.179"></a>
<span class="sourceLineNo">180</span>            SpawnerAnimals.findChunksForSpawning(this, this.spawnHostileMobs, this.spawnPeacefulMobs, this.worldInfo.getWorldTotalTime() % 400L == 0L);<a name="line.180"></a>
<span class="sourceLineNo">181</span>        }<a name="line.181"></a>
<span class="sourceLineNo">182</span><a name="line.182"></a>
<span class="sourceLineNo">183</span>        this.theProfiler.endStartSection("chunkSource");<a name="line.183"></a>
<span class="sourceLineNo">184</span>        this.chunkProvider.unloadQueuedChunks();<a name="line.184"></a>
<span class="sourceLineNo">185</span>        int j = this.calculateSkylightSubtracted(1.0F);<a name="line.185"></a>
<span class="sourceLineNo">186</span><a name="line.186"></a>
<span class="sourceLineNo">187</span>        if (j != this.skylightSubtracted)<a name="line.187"></a>
<span class="sourceLineNo">188</span>        {<a name="line.188"></a>
<span class="sourceLineNo">189</span>            this.skylightSubtracted = j;<a name="line.189"></a>
<span class="sourceLineNo">190</span>        }<a name="line.190"></a>
<span class="sourceLineNo">191</span><a name="line.191"></a>
<span class="sourceLineNo">192</span>        this.worldInfo.incrementTotalWorldTime(this.worldInfo.getWorldTotalTime() + 1L);<a name="line.192"></a>
<span class="sourceLineNo">193</span>        this.worldInfo.setWorldTime(this.worldInfo.getWorldTime() + 1L);<a name="line.193"></a>
<span class="sourceLineNo">194</span>        this.theProfiler.endStartSection("tickPending");<a name="line.194"></a>
<span class="sourceLineNo">195</span>        this.tickUpdates(false);<a name="line.195"></a>
<span class="sourceLineNo">196</span>        this.theProfiler.endStartSection("tickTiles");<a name="line.196"></a>
<span class="sourceLineNo">197</span>        this.tickBlocksAndAmbiance();<a name="line.197"></a>
<span class="sourceLineNo">198</span>        this.theProfiler.endStartSection("chunkMap");<a name="line.198"></a>
<span class="sourceLineNo">199</span>        this.thePlayerManager.updatePlayerInstances();<a name="line.199"></a>
<span class="sourceLineNo">200</span>        this.theProfiler.endStartSection("village");<a name="line.200"></a>
<span class="sourceLineNo">201</span>        this.villageCollectionObj.tick();<a name="line.201"></a>
<span class="sourceLineNo">202</span>        this.villageSiegeObj.tick();<a name="line.202"></a>
<span class="sourceLineNo">203</span>        this.theProfiler.endStartSection("portalForcer");<a name="line.203"></a>
<span class="sourceLineNo">204</span>        this.field_85177_Q.removeStalePortalLocations(this.getTotalWorldTime());<a name="line.204"></a>
<span class="sourceLineNo">205</span>        for (Teleporter tele : customTeleporters)<a name="line.205"></a>
<span class="sourceLineNo">206</span>        {<a name="line.206"></a>
<span class="sourceLineNo">207</span>            tele.removeStalePortalLocations(getTotalWorldTime());<a name="line.207"></a>
<span class="sourceLineNo">208</span>        }<a name="line.208"></a>
<span class="sourceLineNo">209</span>        this.theProfiler.endSection();<a name="line.209"></a>
<span class="sourceLineNo">210</span>        this.sendAndApplyBlockEvents();<a name="line.210"></a>
<span class="sourceLineNo">211</span>    }<a name="line.211"></a>
<span class="sourceLineNo">212</span><a name="line.212"></a>
<span class="sourceLineNo">213</span>    /**<a name="line.213"></a>
<span class="sourceLineNo">214</span>     * only spawns creatures allowed by the chunkProvider<a name="line.214"></a>
<span class="sourceLineNo">215</span>     */<a name="line.215"></a>
<span class="sourceLineNo">216</span>    public SpawnListEntry spawnRandomCreature(EnumCreatureType par1EnumCreatureType, int par2, int par3, int par4)<a name="line.216"></a>
<span class="sourceLineNo">217</span>    {<a name="line.217"></a>
<span class="sourceLineNo">218</span>        List list = this.getChunkProvider().getPossibleCreatures(par1EnumCreatureType, par2, par3, par4);<a name="line.218"></a>
<span class="sourceLineNo">219</span>        list = ForgeEventFactory.getPotentialSpawns(this, par1EnumCreatureType, par2, par3, par4, list);<a name="line.219"></a>
<span class="sourceLineNo">220</span>        return list != null &amp;&amp; !list.isEmpty() ? (SpawnListEntry)WeightedRandom.getRandomItem(this.rand, list) : null;<a name="line.220"></a>
<span class="sourceLineNo">221</span>    }<a name="line.221"></a>
<span class="sourceLineNo">222</span><a name="line.222"></a>
<span class="sourceLineNo">223</span>    /**<a name="line.223"></a>
<span class="sourceLineNo">224</span>     * Updates the flag that indicates whether or not all players in the world are sleeping.<a name="line.224"></a>
<span class="sourceLineNo">225</span>     */<a name="line.225"></a>
<span class="sourceLineNo">226</span>    public void updateAllPlayersSleepingFlag()<a name="line.226"></a>
<span class="sourceLineNo">227</span>    {<a name="line.227"></a>
<span class="sourceLineNo">228</span>        this.allPlayersSleeping = !this.playerEntities.isEmpty();<a name="line.228"></a>
<span class="sourceLineNo">229</span>        Iterator iterator = this.playerEntities.iterator();<a name="line.229"></a>
<span class="sourceLineNo">230</span><a name="line.230"></a>
<span class="sourceLineNo">231</span>        while (iterator.hasNext())<a name="line.231"></a>
<span class="sourceLineNo">232</span>        {<a name="line.232"></a>
<span class="sourceLineNo">233</span>            EntityPlayer entityplayer = (EntityPlayer)iterator.next();<a name="line.233"></a>
<span class="sourceLineNo">234</span><a name="line.234"></a>
<span class="sourceLineNo">235</span>            if (!entityplayer.isPlayerSleeping())<a name="line.235"></a>
<span class="sourceLineNo">236</span>            {<a name="line.236"></a>
<span class="sourceLineNo">237</span>                this.allPlayersSleeping = false;<a name="line.237"></a>
<span class="sourceLineNo">238</span>                break;<a name="line.238"></a>
<span class="sourceLineNo">239</span>            }<a name="line.239"></a>
<span class="sourceLineNo">240</span>        }<a name="line.240"></a>
<span class="sourceLineNo">241</span>    }<a name="line.241"></a>
<span class="sourceLineNo">242</span><a name="line.242"></a>
<span class="sourceLineNo">243</span>    protected void wakeAllPlayers()<a name="line.243"></a>
<span class="sourceLineNo">244</span>    {<a name="line.244"></a>
<span class="sourceLineNo">245</span>        this.allPlayersSleeping = false;<a name="line.245"></a>
<span class="sourceLineNo">246</span>        Iterator iterator = this.playerEntities.iterator();<a name="line.246"></a>
<span class="sourceLineNo">247</span><a name="line.247"></a>
<span class="sourceLineNo">248</span>        while (iterator.hasNext())<a name="line.248"></a>
<span class="sourceLineNo">249</span>        {<a name="line.249"></a>
<span class="sourceLineNo">250</span>            EntityPlayer entityplayer = (EntityPlayer)iterator.next();<a name="line.250"></a>
<span class="sourceLineNo">251</span><a name="line.251"></a>
<span class="sourceLineNo">252</span>            if (entityplayer.isPlayerSleeping())<a name="line.252"></a>
<span class="sourceLineNo">253</span>            {<a name="line.253"></a>
<span class="sourceLineNo">254</span>                entityplayer.wakeUpPlayer(false, false, true);<a name="line.254"></a>
<span class="sourceLineNo">255</span>            }<a name="line.255"></a>
<span class="sourceLineNo">256</span>        }<a name="line.256"></a>
<span class="sourceLineNo">257</span><a name="line.257"></a>
<span class="sourceLineNo">258</span>        this.resetRainAndThunder();<a name="line.258"></a>
<span class="sourceLineNo">259</span>    }<a name="line.259"></a>
<span class="sourceLineNo">260</span><a name="line.260"></a>
<span class="sourceLineNo">261</span>    private void resetRainAndThunder()<a name="line.261"></a>
<span class="sourceLineNo">262</span>    {<a name="line.262"></a>
<span class="sourceLineNo">263</span>        provider.resetRainAndThunder();<a name="line.263"></a>
<span class="sourceLineNo">264</span>    }<a name="line.264"></a>
<span class="sourceLineNo">265</span><a name="line.265"></a>
<span class="sourceLineNo">266</span>    public boolean areAllPlayersAsleep()<a name="line.266"></a>
<span class="sourceLineNo">267</span>    {<a name="line.267"></a>
<span class="sourceLineNo">268</span>        if (this.allPlayersSleeping &amp;&amp; !this.isRemote)<a name="line.268"></a>
<span class="sourceLineNo">269</span>        {<a name="line.269"></a>
<span class="sourceLineNo">270</span>            Iterator iterator = this.playerEntities.iterator();<a name="line.270"></a>
<span class="sourceLineNo">271</span>            EntityPlayer entityplayer;<a name="line.271"></a>
<span class="sourceLineNo">272</span><a name="line.272"></a>
<span class="sourceLineNo">273</span>            do<a name="line.273"></a>
<span class="sourceLineNo">274</span>            {<a name="line.274"></a>
<span class="sourceLineNo">275</span>                if (!iterator.hasNext())<a name="line.275"></a>
<span class="sourceLineNo">276</span>                {<a name="line.276"></a>
<span class="sourceLineNo">277</span>                    return true;<a name="line.277"></a>
<span class="sourceLineNo">278</span>                }<a name="line.278"></a>
<span class="sourceLineNo">279</span><a name="line.279"></a>
<span class="sourceLineNo">280</span>                entityplayer = (EntityPlayer)iterator.next();<a name="line.280"></a>
<span class="sourceLineNo">281</span>            }<a name="line.281"></a>
<span class="sourceLineNo">282</span>            while (entityplayer.isPlayerFullyAsleep());<a name="line.282"></a>
<span class="sourceLineNo">283</span><a name="line.283"></a>
<span class="sourceLineNo">284</span>            return false;<a name="line.284"></a>
<span class="sourceLineNo">285</span>        }<a name="line.285"></a>
<span class="sourceLineNo">286</span>        else<a name="line.286"></a>
<span class="sourceLineNo">287</span>        {<a name="line.287"></a>
<span class="sourceLineNo">288</span>            return false;<a name="line.288"></a>
<span class="sourceLineNo">289</span>        }<a name="line.289"></a>
<span class="sourceLineNo">290</span>    }<a name="line.290"></a>
<span class="sourceLineNo">291</span><a name="line.291"></a>
<span class="sourceLineNo">292</span>    @SideOnly(Side.CLIENT)<a name="line.292"></a>
<span class="sourceLineNo">293</span><a name="line.293"></a>
<span class="sourceLineNo">294</span>    /**<a name="line.294"></a>
<span class="sourceLineNo">295</span>     * Sets a new spawn location by finding an uncovered block at a random (x,z) location in the chunk.<a name="line.295"></a>
<span class="sourceLineNo">296</span>     */<a name="line.296"></a>
<span class="sourceLineNo">297</span>    public void setSpawnLocation()<a name="line.297"></a>
<span class="sourceLineNo">298</span>    {<a name="line.298"></a>
<span class="sourceLineNo">299</span>        if (this.worldInfo.getSpawnY() &lt;= 0)<a name="line.299"></a>
<span class="sourceLineNo">300</span>        {<a name="line.300"></a>
<span class="sourceLineNo">301</span>            this.worldInfo.setSpawnY(64);<a name="line.301"></a>
<span class="sourceLineNo">302</span>        }<a name="line.302"></a>
<span class="sourceLineNo">303</span><a name="line.303"></a>
<span class="sourceLineNo">304</span>        int i = this.worldInfo.getSpawnX();<a name="line.304"></a>
<span class="sourceLineNo">305</span>        int j = this.worldInfo.getSpawnZ();<a name="line.305"></a>
<span class="sourceLineNo">306</span>        int k = 0;<a name="line.306"></a>
<span class="sourceLineNo">307</span><a name="line.307"></a>
<span class="sourceLineNo">308</span>        while (this.getFirstUncoveredBlock(i, j) == 0)<a name="line.308"></a>
<span class="sourceLineNo">309</span>        {<a name="line.309"></a>
<span class="sourceLineNo">310</span>            i += this.rand.nextInt(8) - this.rand.nextInt(8);<a name="line.310"></a>
<span class="sourceLineNo">311</span>            j += this.rand.nextInt(8) - this.rand.nextInt(8);<a name="line.311"></a>
<span class="sourceLineNo">312</span>            ++k;<a name="line.312"></a>
<span class="sourceLineNo">313</span><a name="line.313"></a>
<span class="sourceLineNo">314</span>            if (k == 10000)<a name="line.314"></a>
<span class="sourceLineNo">315</span>            {<a name="line.315"></a>
<span class="sourceLineNo">316</span>                break;<a name="line.316"></a>
<span class="sourceLineNo">317</span>            }<a name="line.317"></a>
<span class="sourceLineNo">318</span>        }<a name="line.318"></a>
<span class="sourceLineNo">319</span><a name="line.319"></a>
<span class="sourceLineNo">320</span>        this.worldInfo.setSpawnX(i);<a name="line.320"></a>
<span class="sourceLineNo">321</span>        this.worldInfo.setSpawnZ(j);<a name="line.321"></a>
<span class="sourceLineNo">322</span>    }<a name="line.322"></a>
<span class="sourceLineNo">323</span><a name="line.323"></a>
<span class="sourceLineNo">324</span>    /**<a name="line.324"></a>
<span class="sourceLineNo">325</span>     * plays random cave ambient sounds and runs updateTick on random blocks within each chunk in the vacinity of a<a name="line.325"></a>
<span class="sourceLineNo">326</span>     * player<a name="line.326"></a>
<span class="sourceLineNo">327</span>     */<a name="line.327"></a>
<span class="sourceLineNo">328</span>    protected void tickBlocksAndAmbiance()<a name="line.328"></a>
<span class="sourceLineNo">329</span>    {<a name="line.329"></a>
<span class="sourceLineNo">330</span>        super.tickBlocksAndAmbiance();<a name="line.330"></a>
<span class="sourceLineNo">331</span>        int i = 0;<a name="line.331"></a>
<span class="sourceLineNo">332</span>        int j = 0;<a name="line.332"></a>
<span class="sourceLineNo">333</span>        Iterator iterator = this.activeChunkSet.iterator();<a name="line.333"></a>
<span class="sourceLineNo">334</span><a name="line.334"></a>
<span class="sourceLineNo">335</span>        doneChunks.retainAll(activeChunkSet);<a name="line.335"></a>
<span class="sourceLineNo">336</span>        if (doneChunks.size() == activeChunkSet.size())<a name="line.336"></a>
<span class="sourceLineNo">337</span>        {<a name="line.337"></a>
<span class="sourceLineNo">338</span>            doneChunks.clear();<a name="line.338"></a>
<span class="sourceLineNo">339</span>        }<a name="line.339"></a>
<span class="sourceLineNo">340</span><a name="line.340"></a>
<span class="sourceLineNo">341</span>        final long startTime = System.nanoTime();<a name="line.341"></a>
<span class="sourceLineNo">342</span><a name="line.342"></a>
<span class="sourceLineNo">343</span>        while (iterator.hasNext())<a name="line.343"></a>
<span class="sourceLineNo">344</span>        {<a name="line.344"></a>
<span class="sourceLineNo">345</span>            ChunkCoordIntPair chunkcoordintpair = (ChunkCoordIntPair)iterator.next();<a name="line.345"></a>
<span class="sourceLineNo">346</span>            int k = chunkcoordintpair.chunkXPos * 16;<a name="line.346"></a>
<span class="sourceLineNo">347</span>            int l = chunkcoordintpair.chunkZPos * 16;<a name="line.347"></a>
<span class="sourceLineNo">348</span>            this.theProfiler.startSection("getChunk");<a name="line.348"></a>
<span class="sourceLineNo">349</span>            Chunk chunk = this.getChunkFromChunkCoords(chunkcoordintpair.chunkXPos, chunkcoordintpair.chunkZPos);<a name="line.349"></a>
<span class="sourceLineNo">350</span>            this.moodSoundAndLightCheck(k, l, chunk);<a name="line.350"></a>
<span class="sourceLineNo">351</span>            this.theProfiler.endStartSection("tickChunk");<a name="line.351"></a>
<span class="sourceLineNo">352</span>            //Limits and evenly distributes the lighting update time<a name="line.352"></a>
<span class="sourceLineNo">353</span>            if (System.nanoTime() - startTime &lt;= 4000000 &amp;&amp; doneChunks.add(chunkcoordintpair))<a name="line.353"></a>
<span class="sourceLineNo">354</span>            {<a name="line.354"></a>
<span class="sourceLineNo">355</span>                chunk.updateSkylight();<a name="line.355"></a>
<span class="sourceLineNo">356</span>            }<a name="line.356"></a>
<span class="sourceLineNo">357</span>            this.theProfiler.endStartSection("thunder");<a name="line.357"></a>
<span class="sourceLineNo">358</span>            int i1;<a name="line.358"></a>
<span class="sourceLineNo">359</span>            int j1;<a name="line.359"></a>
<span class="sourceLineNo">360</span>            int k1;<a name="line.360"></a>
<span class="sourceLineNo">361</span>            int l1;<a name="line.361"></a>
<span class="sourceLineNo">362</span><a name="line.362"></a>
<span class="sourceLineNo">363</span>            if (provider.canDoLightning(chunk) &amp;&amp; this.rand.nextInt(100000) == 0 &amp;&amp; this.isRaining() &amp;&amp; this.isThundering())<a name="line.363"></a>
<span class="sourceLineNo">364</span>            {<a name="line.364"></a>
<span class="sourceLineNo">365</span>                this.updateLCG = this.updateLCG * 3 + 1013904223;<a name="line.365"></a>
<span class="sourceLineNo">366</span>                i1 = this.updateLCG &gt;&gt; 2;<a name="line.366"></a>
<span class="sourceLineNo">367</span>                j1 = k + (i1 &amp; 15);<a name="line.367"></a>
<span class="sourceLineNo">368</span>                k1 = l + (i1 &gt;&gt; 8 &amp; 15);<a name="line.368"></a>
<span class="sourceLineNo">369</span>                l1 = this.getPrecipitationHeight(j1, k1);<a name="line.369"></a>
<span class="sourceLineNo">370</span><a name="line.370"></a>
<span class="sourceLineNo">371</span>                if (this.canLightningStrikeAt(j1, l1, k1))<a name="line.371"></a>
<span class="sourceLineNo">372</span>                {<a name="line.372"></a>
<span class="sourceLineNo">373</span>                    this.addWeatherEffect(new EntityLightningBolt(this, (double)j1, (double)l1, (double)k1));<a name="line.373"></a>
<span class="sourceLineNo">374</span>                }<a name="line.374"></a>
<span class="sourceLineNo">375</span>            }<a name="line.375"></a>
<span class="sourceLineNo">376</span><a name="line.376"></a>
<span class="sourceLineNo">377</span>            this.theProfiler.endStartSection("iceandsnow");<a name="line.377"></a>
<span class="sourceLineNo">378</span>            int i2;<a name="line.378"></a>
<span class="sourceLineNo">379</span><a name="line.379"></a>
<span class="sourceLineNo">380</span>            if (provider.canDoRainSnowIce(chunk) &amp;&amp; this.rand.nextInt(16) == 0)<a name="line.380"></a>
<span class="sourceLineNo">381</span>            {<a name="line.381"></a>
<span class="sourceLineNo">382</span>                this.updateLCG = this.updateLCG * 3 + 1013904223;<a name="line.382"></a>
<span class="sourceLineNo">383</span>                i1 = this.updateLCG &gt;&gt; 2;<a name="line.383"></a>
<span class="sourceLineNo">384</span>                j1 = i1 &amp; 15;<a name="line.384"></a>
<span class="sourceLineNo">385</span>                k1 = i1 &gt;&gt; 8 &amp; 15;<a name="line.385"></a>
<span class="sourceLineNo">386</span>                l1 = this.getPrecipitationHeight(j1 + k, k1 + l);<a name="line.386"></a>
<span class="sourceLineNo">387</span><a name="line.387"></a>
<span class="sourceLineNo">388</span>                if (this.isBlockFreezableNaturally(j1 + k, l1 - 1, k1 + l))<a name="line.388"></a>
<span class="sourceLineNo">389</span>                {<a name="line.389"></a>
<span class="sourceLineNo">390</span>                    this.setBlock(j1 + k, l1 - 1, k1 + l, Block.ice.blockID);<a name="line.390"></a>
<span class="sourceLineNo">391</span>                }<a name="line.391"></a>
<span class="sourceLineNo">392</span><a name="line.392"></a>
<span class="sourceLineNo">393</span>                if (this.isRaining() &amp;&amp; this.canSnowAt(j1 + k, l1, k1 + l))<a name="line.393"></a>
<span class="sourceLineNo">394</span>                {<a name="line.394"></a>
<span class="sourceLineNo">395</span>                    this.setBlock(j1 + k, l1, k1 + l, Block.snow.blockID);<a name="line.395"></a>
<span class="sourceLineNo">396</span>                }<a name="line.396"></a>
<span class="sourceLineNo">397</span><a name="line.397"></a>
<span class="sourceLineNo">398</span>                if (this.isRaining())<a name="line.398"></a>
<span class="sourceLineNo">399</span>                {<a name="line.399"></a>
<span class="sourceLineNo">400</span>                    BiomeGenBase biomegenbase = this.getBiomeGenForCoords(j1 + k, k1 + l);<a name="line.400"></a>
<span class="sourceLineNo">401</span><a name="line.401"></a>
<span class="sourceLineNo">402</span>                    if (biomegenbase.canSpawnLightningBolt())<a name="line.402"></a>
<span class="sourceLineNo">403</span>                    {<a name="line.403"></a>
<span class="sourceLineNo">404</span>                        i2 = this.getBlockId(j1 + k, l1 - 1, k1 + l);<a name="line.404"></a>
<span class="sourceLineNo">405</span><a name="line.405"></a>
<span class="sourceLineNo">406</span>                        if (i2 != 0)<a name="line.406"></a>
<span class="sourceLineNo">407</span>                        {<a name="line.407"></a>
<span class="sourceLineNo">408</span>                            Block.blocksList[i2].fillWithRain(this, j1 + k, l1 - 1, k1 + l);<a name="line.408"></a>
<span class="sourceLineNo">409</span>                        }<a name="line.409"></a>
<span class="sourceLineNo">410</span>                    }<a name="line.410"></a>
<span class="sourceLineNo">411</span>                }<a name="line.411"></a>
<span class="sourceLineNo">412</span>            }<a name="line.412"></a>
<span class="sourceLineNo">413</span><a name="line.413"></a>
<span class="sourceLineNo">414</span>            this.theProfiler.endStartSection("tickTiles");<a name="line.414"></a>
<span class="sourceLineNo">415</span>            ExtendedBlockStorage[] aextendedblockstorage = chunk.getBlockStorageArray();<a name="line.415"></a>
<span class="sourceLineNo">416</span>            j1 = aextendedblockstorage.length;<a name="line.416"></a>
<span class="sourceLineNo">417</span><a name="line.417"></a>
<span class="sourceLineNo">418</span>            for (k1 = 0; k1 &lt; j1; ++k1)<a name="line.418"></a>
<span class="sourceLineNo">419</span>            {<a name="line.419"></a>
<span class="sourceLineNo">420</span>                ExtendedBlockStorage extendedblockstorage = aextendedblockstorage[k1];<a name="line.420"></a>
<span class="sourceLineNo">421</span><a name="line.421"></a>
<span class="sourceLineNo">422</span>                if (extendedblockstorage != null &amp;&amp; extendedblockstorage.getNeedsRandomTick())<a name="line.422"></a>
<span class="sourceLineNo">423</span>                {<a name="line.423"></a>
<span class="sourceLineNo">424</span>                    for (int j2 = 0; j2 &lt; 3; ++j2)<a name="line.424"></a>
<span class="sourceLineNo">425</span>                    {<a name="line.425"></a>
<span class="sourceLineNo">426</span>                        this.updateLCG = this.updateLCG * 3 + 1013904223;<a name="line.426"></a>
<span class="sourceLineNo">427</span>                        i2 = this.updateLCG &gt;&gt; 2;<a name="line.427"></a>
<span class="sourceLineNo">428</span>                        int k2 = i2 &amp; 15;<a name="line.428"></a>
<span class="sourceLineNo">429</span>                        int l2 = i2 &gt;&gt; 8 &amp; 15;<a name="line.429"></a>
<span class="sourceLineNo">430</span>                        int i3 = i2 &gt;&gt; 16 &amp; 15;<a name="line.430"></a>
<span class="sourceLineNo">431</span>                        int j3 = extendedblockstorage.getExtBlockID(k2, i3, l2);<a name="line.431"></a>
<span class="sourceLineNo">432</span>                        ++j;<a name="line.432"></a>
<span class="sourceLineNo">433</span>                        Block block = Block.blocksList[j3];<a name="line.433"></a>
<span class="sourceLineNo">434</span><a name="line.434"></a>
<span class="sourceLineNo">435</span>                        if (block != null &amp;&amp; block.getTickRandomly())<a name="line.435"></a>
<span class="sourceLineNo">436</span>                        {<a name="line.436"></a>
<span class="sourceLineNo">437</span>                            ++i;<a name="line.437"></a>
<span class="sourceLineNo">438</span>                            block.updateTick(this, k2 + k, i3 + extendedblockstorage.getYLocation(), l2 + l, this.rand);<a name="line.438"></a>
<span class="sourceLineNo">439</span>                        }<a name="line.439"></a>
<span class="sourceLineNo">440</span>                    }<a name="line.440"></a>
<span class="sourceLineNo">441</span>                }<a name="line.441"></a>
<span class="sourceLineNo">442</span>            }<a name="line.442"></a>
<span class="sourceLineNo">443</span><a name="line.443"></a>
<span class="sourceLineNo">444</span>            this.theProfiler.endSection();<a name="line.444"></a>
<span class="sourceLineNo">445</span>        }<a name="line.445"></a>
<span class="sourceLineNo">446</span>    }<a name="line.446"></a>
<span class="sourceLineNo">447</span><a name="line.447"></a>
<span class="sourceLineNo">448</span>    /**<a name="line.448"></a>
<span class="sourceLineNo">449</span>     * Returns true if the given block will receive a scheduled tick in the future. Args: X, Y, Z, blockID<a name="line.449"></a>
<span class="sourceLineNo">450</span>     */<a name="line.450"></a>
<span class="sourceLineNo">451</span>    public boolean isBlockTickScheduled(int par1, int par2, int par3, int par4)<a name="line.451"></a>
<span class="sourceLineNo">452</span>    {<a name="line.452"></a>
<span class="sourceLineNo">453</span>        NextTickListEntry nextticklistentry = new NextTickListEntry(par1, par2, par3, par4);<a name="line.453"></a>
<span class="sourceLineNo">454</span>        return this.field_94579_S.contains(nextticklistentry);<a name="line.454"></a>
<span class="sourceLineNo">455</span>    }<a name="line.455"></a>
<span class="sourceLineNo">456</span><a name="line.456"></a>
<span class="sourceLineNo">457</span>    /**<a name="line.457"></a>
<span class="sourceLineNo">458</span>     * Schedules a tick to a block with a delay (Most commonly the tick rate)<a name="line.458"></a>
<span class="sourceLineNo">459</span>     */<a name="line.459"></a>
<span class="sourceLineNo">460</span>    public void scheduleBlockUpdate(int par1, int par2, int par3, int par4, int par5)<a name="line.460"></a>
<span class="sourceLineNo">461</span>    {<a name="line.461"></a>
<span class="sourceLineNo">462</span>        this.func_82740_a(par1, par2, par3, par4, par5, 0);<a name="line.462"></a>
<span class="sourceLineNo">463</span>    }<a name="line.463"></a>
<span class="sourceLineNo">464</span><a name="line.464"></a>
<span class="sourceLineNo">465</span>    public void func_82740_a(int par1, int par2, int par3, int par4, int par5, int par6)<a name="line.465"></a>
<span class="sourceLineNo">466</span>    {<a name="line.466"></a>
<span class="sourceLineNo">467</span>        NextTickListEntry nextticklistentry = new NextTickListEntry(par1, par2, par3, par4);<a name="line.467"></a>
<span class="sourceLineNo">468</span>        //Keeping here as a note for future when it may be restored.<a name="line.468"></a>
<span class="sourceLineNo">469</span>        //boolean isForced = getPersistentChunks().containsKey(new ChunkCoordIntPair(nextticklistentry.xCoord &gt;&gt; 4, nextticklistentry.zCoord &gt;&gt; 4));<a name="line.469"></a>
<span class="sourceLineNo">470</span>        //byte b0 = isForced ? 0 : 8;<a name="line.470"></a>
<span class="sourceLineNo">471</span>        byte b0 = 0;<a name="line.471"></a>
<span class="sourceLineNo">472</span><a name="line.472"></a>
<span class="sourceLineNo">473</span>        if (this.scheduledUpdatesAreImmediate &amp;&amp; par4 &gt; 0)<a name="line.473"></a>
<span class="sourceLineNo">474</span>        {<a name="line.474"></a>
<span class="sourceLineNo">475</span>            if (Block.blocksList[par4].func_82506_l())<a name="line.475"></a>
<span class="sourceLineNo">476</span>            {<a name="line.476"></a>
<span class="sourceLineNo">477</span>                if (this.checkChunksExist(nextticklistentry.xCoord - b0, nextticklistentry.yCoord - b0, nextticklistentry.zCoord - b0, nextticklistentry.xCoord + b0, nextticklistentry.yCoord + b0, nextticklistentry.zCoord + b0))<a name="line.477"></a>
<span class="sourceLineNo">478</span>                {<a name="line.478"></a>
<span class="sourceLineNo">479</span>                    int k1 = this.getBlockId(nextticklistentry.xCoord, nextticklistentry.yCoord, nextticklistentry.zCoord);<a name="line.479"></a>
<span class="sourceLineNo">480</span><a name="line.480"></a>
<span class="sourceLineNo">481</span>                    if (k1 == nextticklistentry.blockID &amp;&amp; k1 &gt; 0)<a name="line.481"></a>
<span class="sourceLineNo">482</span>                    {<a name="line.482"></a>
<span class="sourceLineNo">483</span>                        Block.blocksList[k1].updateTick(this, nextticklistentry.xCoord, nextticklistentry.yCoord, nextticklistentry.zCoord, this.rand);<a name="line.483"></a>
<span class="sourceLineNo">484</span>                    }<a name="line.484"></a>
<span class="sourceLineNo">485</span>                }<a name="line.485"></a>
<span class="sourceLineNo">486</span><a name="line.486"></a>
<span class="sourceLineNo">487</span>                return;<a name="line.487"></a>
<span class="sourceLineNo">488</span>            }<a name="line.488"></a>
<span class="sourceLineNo">489</span><a name="line.489"></a>
<span class="sourceLineNo">490</span>            par5 = 1;<a name="line.490"></a>
<span class="sourceLineNo">491</span>        }<a name="line.491"></a>
<span class="sourceLineNo">492</span><a name="line.492"></a>
<span class="sourceLineNo">493</span>        if (this.checkChunksExist(par1 - b0, par2 - b0, par3 - b0, par1 + b0, par2 + b0, par3 + b0))<a name="line.493"></a>
<span class="sourceLineNo">494</span>        {<a name="line.494"></a>
<span class="sourceLineNo">495</span>            if (par4 &gt; 0)<a name="line.495"></a>
<span class="sourceLineNo">496</span>            {<a name="line.496"></a>
<span class="sourceLineNo">497</span>                nextticklistentry.setScheduledTime((long)par5 + this.worldInfo.getWorldTotalTime());<a name="line.497"></a>
<span class="sourceLineNo">498</span>                nextticklistentry.func_82753_a(par6);<a name="line.498"></a>
<span class="sourceLineNo">499</span>            }<a name="line.499"></a>
<span class="sourceLineNo">500</span><a name="line.500"></a>
<span class="sourceLineNo">501</span>            if (!this.field_73064_N.contains(nextticklistentry))<a name="line.501"></a>
<span class="sourceLineNo">502</span>            {<a name="line.502"></a>
<span class="sourceLineNo">503</span>                this.field_73064_N.add(nextticklistentry);<a name="line.503"></a>
<span class="sourceLineNo">504</span>                this.pendingTickListEntries.add(nextticklistentry);<a name="line.504"></a>
<span class="sourceLineNo">505</span>            }<a name="line.505"></a>
<span class="sourceLineNo">506</span>        }<a name="line.506"></a>
<span class="sourceLineNo">507</span>    }<a name="line.507"></a>
<span class="sourceLineNo">508</span><a name="line.508"></a>
<span class="sourceLineNo">509</span>    /**<a name="line.509"></a>
<span class="sourceLineNo">510</span>     * Schedules a block update from the saved information in a chunk. Called when the chunk is loaded.<a name="line.510"></a>
<span class="sourceLineNo">511</span>     */<a name="line.511"></a>
<span class="sourceLineNo">512</span>    public void scheduleBlockUpdateFromLoad(int par1, int par2, int par3, int par4, int par5, int par6)<a name="line.512"></a>
<span class="sourceLineNo">513</span>    {<a name="line.513"></a>
<span class="sourceLineNo">514</span>        NextTickListEntry nextticklistentry = new NextTickListEntry(par1, par2, par3, par4);<a name="line.514"></a>
<span class="sourceLineNo">515</span>        nextticklistentry.func_82753_a(par6);<a name="line.515"></a>
<span class="sourceLineNo">516</span><a name="line.516"></a>
<span class="sourceLineNo">517</span>        if (par4 &gt; 0)<a name="line.517"></a>
<span class="sourceLineNo">518</span>        {<a name="line.518"></a>
<span class="sourceLineNo">519</span>            nextticklistentry.setScheduledTime((long)par5 + this.worldInfo.getWorldTotalTime());<a name="line.519"></a>
<span class="sourceLineNo">520</span>        }<a name="line.520"></a>
<span class="sourceLineNo">521</span><a name="line.521"></a>
<span class="sourceLineNo">522</span>        if (!this.field_73064_N.contains(nextticklistentry))<a name="line.522"></a>
<span class="sourceLineNo">523</span>        {<a name="line.523"></a>
<span class="sourceLineNo">524</span>            this.field_73064_N.add(nextticklistentry);<a name="line.524"></a>
<span class="sourceLineNo">525</span>            this.pendingTickListEntries.add(nextticklistentry);<a name="line.525"></a>
<span class="sourceLineNo">526</span>        }<a name="line.526"></a>
<span class="sourceLineNo">527</span>    }<a name="line.527"></a>
<span class="sourceLineNo">528</span><a name="line.528"></a>
<span class="sourceLineNo">529</span>    /**<a name="line.529"></a>
<span class="sourceLineNo">530</span>     * Updates (and cleans up) entities and tile entities<a name="line.530"></a>
<span class="sourceLineNo">531</span>     */<a name="line.531"></a>
<span class="sourceLineNo">532</span>    public void updateEntities()<a name="line.532"></a>
<span class="sourceLineNo">533</span>    {<a name="line.533"></a>
<span class="sourceLineNo">534</span>        if (this.playerEntities.isEmpty() &amp;&amp; getPersistentChunks().isEmpty())<a name="line.534"></a>
<span class="sourceLineNo">535</span>        {<a name="line.535"></a>
<span class="sourceLineNo">536</span>            if (this.updateEntityTick++ &gt;= 1200)<a name="line.536"></a>
<span class="sourceLineNo">537</span>            {<a name="line.537"></a>
<span class="sourceLineNo">538</span>                return;<a name="line.538"></a>
<span class="sourceLineNo">539</span>            }<a name="line.539"></a>
<span class="sourceLineNo">540</span>        }<a name="line.540"></a>
<span class="sourceLineNo">541</span>        else<a name="line.541"></a>
<span class="sourceLineNo">542</span>        {<a name="line.542"></a>
<span class="sourceLineNo">543</span>            this.resetUpdateEntityTick();<a name="line.543"></a>
<span class="sourceLineNo">544</span>        }<a name="line.544"></a>
<span class="sourceLineNo">545</span><a name="line.545"></a>
<span class="sourceLineNo">546</span>        super.updateEntities();<a name="line.546"></a>
<span class="sourceLineNo">547</span>    }<a name="line.547"></a>
<span class="sourceLineNo">548</span><a name="line.548"></a>
<span class="sourceLineNo">549</span>    /**<a name="line.549"></a>
<span class="sourceLineNo">550</span>     * Resets the updateEntityTick field to 0<a name="line.550"></a>
<span class="sourceLineNo">551</span>     */<a name="line.551"></a>
<span class="sourceLineNo">552</span>    public void resetUpdateEntityTick()<a name="line.552"></a>
<span class="sourceLineNo">553</span>    {<a name="line.553"></a>
<span class="sourceLineNo">554</span>        this.updateEntityTick = 0;<a name="line.554"></a>
<span class="sourceLineNo">555</span>    }<a name="line.555"></a>
<span class="sourceLineNo">556</span><a name="line.556"></a>
<span class="sourceLineNo">557</span>    /**<a name="line.557"></a>
<span class="sourceLineNo">558</span>     * Runs through the list of updates to run and ticks them<a name="line.558"></a>
<span class="sourceLineNo">559</span>     */<a name="line.559"></a>
<span class="sourceLineNo">560</span>    public boolean tickUpdates(boolean par1)<a name="line.560"></a>
<span class="sourceLineNo">561</span>    {<a name="line.561"></a>
<span class="sourceLineNo">562</span>        int i = this.pendingTickListEntries.size();<a name="line.562"></a>
<span class="sourceLineNo">563</span><a name="line.563"></a>
<span class="sourceLineNo">564</span>        if (i != this.field_73064_N.size())<a name="line.564"></a>
<span class="sourceLineNo">565</span>        {<a name="line.565"></a>
<span class="sourceLineNo">566</span>            throw new IllegalStateException("TickNextTick list out of synch");<a name="line.566"></a>
<span class="sourceLineNo">567</span>        }<a name="line.567"></a>
<span class="sourceLineNo">568</span>        else<a name="line.568"></a>
<span class="sourceLineNo">569</span>        {<a name="line.569"></a>
<span class="sourceLineNo">570</span>            if (i &gt; 1000)<a name="line.570"></a>
<span class="sourceLineNo">571</span>            {<a name="line.571"></a>
<span class="sourceLineNo">572</span>                i = 1000;<a name="line.572"></a>
<span class="sourceLineNo">573</span>            }<a name="line.573"></a>
<span class="sourceLineNo">574</span><a name="line.574"></a>
<span class="sourceLineNo">575</span>            this.theProfiler.startSection("cleaning");<a name="line.575"></a>
<span class="sourceLineNo">576</span>            NextTickListEntry nextticklistentry;<a name="line.576"></a>
<span class="sourceLineNo">577</span><a name="line.577"></a>
<span class="sourceLineNo">578</span>            for (int j = 0; j &lt; i; ++j)<a name="line.578"></a>
<span class="sourceLineNo">579</span>            {<a name="line.579"></a>
<span class="sourceLineNo">580</span>                nextticklistentry = (NextTickListEntry)this.pendingTickListEntries.first();<a name="line.580"></a>
<span class="sourceLineNo">581</span><a name="line.581"></a>
<span class="sourceLineNo">582</span>                if (!par1 &amp;&amp; nextticklistentry.scheduledTime &gt; this.worldInfo.getWorldTotalTime())<a name="line.582"></a>
<span class="sourceLineNo">583</span>                {<a name="line.583"></a>
<span class="sourceLineNo">584</span>                    break;<a name="line.584"></a>
<span class="sourceLineNo">585</span>                }<a name="line.585"></a>
<span class="sourceLineNo">586</span><a name="line.586"></a>
<span class="sourceLineNo">587</span>                this.pendingTickListEntries.remove(nextticklistentry);<a name="line.587"></a>
<span class="sourceLineNo">588</span>                this.field_73064_N.remove(nextticklistentry);<a name="line.588"></a>
<span class="sourceLineNo">589</span>                this.field_94579_S.add(nextticklistentry);<a name="line.589"></a>
<span class="sourceLineNo">590</span>            }<a name="line.590"></a>
<span class="sourceLineNo">591</span><a name="line.591"></a>
<span class="sourceLineNo">592</span>            this.theProfiler.endSection();<a name="line.592"></a>
<span class="sourceLineNo">593</span>            this.theProfiler.startSection("ticking");<a name="line.593"></a>
<span class="sourceLineNo">594</span>            Iterator iterator = this.field_94579_S.iterator();<a name="line.594"></a>
<span class="sourceLineNo">595</span><a name="line.595"></a>
<span class="sourceLineNo">596</span>            while (iterator.hasNext())<a name="line.596"></a>
<span class="sourceLineNo">597</span>            {<a name="line.597"></a>
<span class="sourceLineNo">598</span>                nextticklistentry = (NextTickListEntry)iterator.next();<a name="line.598"></a>
<span class="sourceLineNo">599</span>                iterator.remove();<a name="line.599"></a>
<span class="sourceLineNo">600</span>                //Keeping here as a note for future when it may be restored.<a name="line.600"></a>
<span class="sourceLineNo">601</span>                //boolean isForced = getPersistentChunks().containsKey(new ChunkCoordIntPair(nextticklistentry.xCoord &gt;&gt; 4, nextticklistentry.zCoord &gt;&gt; 4));<a name="line.601"></a>
<span class="sourceLineNo">602</span>                //byte b0 = isForced ? 0 : 8;<a name="line.602"></a>
<span class="sourceLineNo">603</span>                byte b0 = 0;<a name="line.603"></a>
<span class="sourceLineNo">604</span><a name="line.604"></a>
<span class="sourceLineNo">605</span>                if (this.checkChunksExist(nextticklistentry.xCoord - b0, nextticklistentry.yCoord - b0, nextticklistentry.zCoord - b0, nextticklistentry.xCoord + b0, nextticklistentry.yCoord + b0, nextticklistentry.zCoord + b0))<a name="line.605"></a>
<span class="sourceLineNo">606</span>                {<a name="line.606"></a>
<span class="sourceLineNo">607</span>                    int k = this.getBlockId(nextticklistentry.xCoord, nextticklistentry.yCoord, nextticklistentry.zCoord);<a name="line.607"></a>
<span class="sourceLineNo">608</span><a name="line.608"></a>
<span class="sourceLineNo">609</span>                    if (k &gt; 0 &amp;&amp; Block.isAssociatedBlockID(k, nextticklistentry.blockID))<a name="line.609"></a>
<span class="sourceLineNo">610</span>                    {<a name="line.610"></a>
<span class="sourceLineNo">611</span>                        try<a name="line.611"></a>
<span class="sourceLineNo">612</span>                        {<a name="line.612"></a>
<span class="sourceLineNo">613</span>                            Block.blocksList[k].updateTick(this, nextticklistentry.xCoord, nextticklistentry.yCoord, nextticklistentry.zCoord, this.rand);<a name="line.613"></a>
<span class="sourceLineNo">614</span>                        }<a name="line.614"></a>
<span class="sourceLineNo">615</span>                        catch (Throwable throwable)<a name="line.615"></a>
<span class="sourceLineNo">616</span>                        {<a name="line.616"></a>
<span class="sourceLineNo">617</span>                            CrashReport crashreport = CrashReport.makeCrashReport(throwable, "Exception while ticking a block");<a name="line.617"></a>
<span class="sourceLineNo">618</span>                            CrashReportCategory crashreportcategory = crashreport.makeCategory("Block being ticked");<a name="line.618"></a>
<span class="sourceLineNo">619</span>                            int l;<a name="line.619"></a>
<span class="sourceLineNo">620</span><a name="line.620"></a>
<span class="sourceLineNo">621</span>                            try<a name="line.621"></a>
<span class="sourceLineNo">622</span>                            {<a name="line.622"></a>
<span class="sourceLineNo">623</span>                                l = this.getBlockMetadata(nextticklistentry.xCoord, nextticklistentry.yCoord, nextticklistentry.zCoord);<a name="line.623"></a>
<span class="sourceLineNo">624</span>                            }<a name="line.624"></a>
<span class="sourceLineNo">625</span>                            catch (Throwable throwable1)<a name="line.625"></a>
<span class="sourceLineNo">626</span>                            {<a name="line.626"></a>
<span class="sourceLineNo">627</span>                                l = -1;<a name="line.627"></a>
<span class="sourceLineNo">628</span>                            }<a name="line.628"></a>
<span class="sourceLineNo">629</span><a name="line.629"></a>
<span class="sourceLineNo">630</span>                            CrashReportCategory.func_85068_a(crashreportcategory, nextticklistentry.xCoord, nextticklistentry.yCoord, nextticklistentry.zCoord, k, l);<a name="line.630"></a>
<span class="sourceLineNo">631</span>                            throw new ReportedException(crashreport);<a name="line.631"></a>
<span class="sourceLineNo">632</span>                        }<a name="line.632"></a>
<span class="sourceLineNo">633</span>                    }<a name="line.633"></a>
<span class="sourceLineNo">634</span>                }<a name="line.634"></a>
<span class="sourceLineNo">635</span>                else<a name="line.635"></a>
<span class="sourceLineNo">636</span>                {<a name="line.636"></a>
<span class="sourceLineNo">637</span>                    this.scheduleBlockUpdate(nextticklistentry.xCoord, nextticklistentry.yCoord, nextticklistentry.zCoord, nextticklistentry.blockID, 0);<a name="line.637"></a>
<span class="sourceLineNo">638</span>                }<a name="line.638"></a>
<span class="sourceLineNo">639</span>            }<a name="line.639"></a>
<span class="sourceLineNo">640</span><a name="line.640"></a>
<span class="sourceLineNo">641</span>            this.theProfiler.endSection();<a name="line.641"></a>
<span class="sourceLineNo">642</span>            this.field_94579_S.clear();<a name="line.642"></a>
<span class="sourceLineNo">643</span>            return !this.pendingTickListEntries.isEmpty();<a name="line.643"></a>
<span class="sourceLineNo">644</span>        }<a name="line.644"></a>
<span class="sourceLineNo">645</span>    }<a name="line.645"></a>
<span class="sourceLineNo">646</span><a name="line.646"></a>
<span class="sourceLineNo">647</span>    public List getPendingBlockUpdates(Chunk par1Chunk, boolean par2)<a name="line.647"></a>
<span class="sourceLineNo">648</span>    {<a name="line.648"></a>
<span class="sourceLineNo">649</span>        ArrayList arraylist = null;<a name="line.649"></a>
<span class="sourceLineNo">650</span>        ChunkCoordIntPair chunkcoordintpair = par1Chunk.getChunkCoordIntPair();<a name="line.650"></a>
<span class="sourceLineNo">651</span>        int i = (chunkcoordintpair.chunkXPos &lt;&lt; 4) - 2;<a name="line.651"></a>
<span class="sourceLineNo">652</span>        int j = i + 16 + 2;<a name="line.652"></a>
<span class="sourceLineNo">653</span>        int k = (chunkcoordintpair.chunkZPos &lt;&lt; 4) - 2;<a name="line.653"></a>
<span class="sourceLineNo">654</span>        int l = k + 16 + 2;<a name="line.654"></a>
<span class="sourceLineNo">655</span><a name="line.655"></a>
<span class="sourceLineNo">656</span>        for (int i1 = 0; i1 &lt; 2; ++i1)<a name="line.656"></a>
<span class="sourceLineNo">657</span>        {<a name="line.657"></a>
<span class="sourceLineNo">658</span>            Iterator iterator;<a name="line.658"></a>
<span class="sourceLineNo">659</span><a name="line.659"></a>
<span class="sourceLineNo">660</span>            if (i1 == 0)<a name="line.660"></a>
<span class="sourceLineNo">661</span>            {<a name="line.661"></a>
<span class="sourceLineNo">662</span>                iterator = this.pendingTickListEntries.iterator();<a name="line.662"></a>
<span class="sourceLineNo">663</span>            }<a name="line.663"></a>
<span class="sourceLineNo">664</span>            else<a name="line.664"></a>
<span class="sourceLineNo">665</span>            {<a name="line.665"></a>
<span class="sourceLineNo">666</span>                iterator = this.field_94579_S.iterator();<a name="line.666"></a>
<span class="sourceLineNo">667</span><a name="line.667"></a>
<span class="sourceLineNo">668</span>                if (!this.field_94579_S.isEmpty())<a name="line.668"></a>
<span class="sourceLineNo">669</span>                {<a name="line.669"></a>
<span class="sourceLineNo">670</span>                    System.out.println(this.field_94579_S.size());<a name="line.670"></a>
<span class="sourceLineNo">671</span>                }<a name="line.671"></a>
<span class="sourceLineNo">672</span>            }<a name="line.672"></a>
<span class="sourceLineNo">673</span><a name="line.673"></a>
<span class="sourceLineNo">674</span>            while (iterator.hasNext())<a name="line.674"></a>
<span class="sourceLineNo">675</span>            {<a name="line.675"></a>
<span class="sourceLineNo">676</span>                NextTickListEntry nextticklistentry = (NextTickListEntry)iterator.next();<a name="line.676"></a>
<span class="sourceLineNo">677</span><a name="line.677"></a>
<span class="sourceLineNo">678</span>                if (nextticklistentry.xCoord &gt;= i &amp;&amp; nextticklistentry.xCoord &lt; j &amp;&amp; nextticklistentry.zCoord &gt;= k &amp;&amp; nextticklistentry.zCoord &lt; l)<a name="line.678"></a>
<span class="sourceLineNo">679</span>                {<a name="line.679"></a>
<span class="sourceLineNo">680</span>                    if (par2)<a name="line.680"></a>
<span class="sourceLineNo">681</span>                    {<a name="line.681"></a>
<span class="sourceLineNo">682</span>                        this.field_73064_N.remove(nextticklistentry);<a name="line.682"></a>
<span class="sourceLineNo">683</span>                        iterator.remove();<a name="line.683"></a>
<span class="sourceLineNo">684</span>                    }<a name="line.684"></a>
<span class="sourceLineNo">685</span><a name="line.685"></a>
<span class="sourceLineNo">686</span>                    if (arraylist == null)<a name="line.686"></a>
<span class="sourceLineNo">687</span>                    {<a name="line.687"></a>
<span class="sourceLineNo">688</span>                        arraylist = new ArrayList();<a name="line.688"></a>
<span class="sourceLineNo">689</span>                    }<a name="line.689"></a>
<span class="sourceLineNo">690</span><a name="line.690"></a>
<span class="sourceLineNo">691</span>                    arraylist.add(nextticklistentry);<a name="line.691"></a>
<span class="sourceLineNo">692</span>                }<a name="line.692"></a>
<span class="sourceLineNo">693</span>            }<a name="line.693"></a>
<span class="sourceLineNo">694</span>        }<a name="line.694"></a>
<span class="sourceLineNo">695</span><a name="line.695"></a>
<span class="sourceLineNo">696</span>        return arraylist;<a name="line.696"></a>
<span class="sourceLineNo">697</span>    }<a name="line.697"></a>
<span class="sourceLineNo">698</span><a name="line.698"></a>
<span class="sourceLineNo">699</span>    /**<a name="line.699"></a>
<span class="sourceLineNo">700</span>     * Will update the entity in the world if the chunk the entity is in is currently loaded or its forced to update.<a name="line.700"></a>
<span class="sourceLineNo">701</span>     * Args: entity, forceUpdate<a name="line.701"></a>
<span class="sourceLineNo">702</span>     */<a name="line.702"></a>
<span class="sourceLineNo">703</span>    public void updateEntityWithOptionalForce(Entity par1Entity, boolean par2)<a name="line.703"></a>
<span class="sourceLineNo">704</span>    {<a name="line.704"></a>
<span class="sourceLineNo">705</span>        if (!this.mcServer.getCanSpawnAnimals() &amp;&amp; (par1Entity instanceof EntityAnimal || par1Entity instanceof EntityWaterMob))<a name="line.705"></a>
<span class="sourceLineNo">706</span>        {<a name="line.706"></a>
<span class="sourceLineNo">707</span>            par1Entity.setDead();<a name="line.707"></a>
<span class="sourceLineNo">708</span>        }<a name="line.708"></a>
<span class="sourceLineNo">709</span><a name="line.709"></a>
<span class="sourceLineNo">710</span>        if (!this.mcServer.getCanSpawnNPCs() &amp;&amp; par1Entity instanceof INpc)<a name="line.710"></a>
<span class="sourceLineNo">711</span>        {<a name="line.711"></a>
<span class="sourceLineNo">712</span>            par1Entity.setDead();<a name="line.712"></a>
<span class="sourceLineNo">713</span>        }<a name="line.713"></a>
<span class="sourceLineNo">714</span><a name="line.714"></a>
<span class="sourceLineNo">715</span>        if (!(par1Entity.riddenByEntity instanceof EntityPlayer))<a name="line.715"></a>
<span class="sourceLineNo">716</span>        {<a name="line.716"></a>
<span class="sourceLineNo">717</span>            super.updateEntityWithOptionalForce(par1Entity, par2);<a name="line.717"></a>
<span class="sourceLineNo">718</span>        }<a name="line.718"></a>
<span class="sourceLineNo">719</span>    }<a name="line.719"></a>
<span class="sourceLineNo">720</span><a name="line.720"></a>
<span class="sourceLineNo">721</span>    /**<a name="line.721"></a>
<span class="sourceLineNo">722</span>     * direct call to super.updateEntityWithOptionalForce<a name="line.722"></a>
<span class="sourceLineNo">723</span>     */<a name="line.723"></a>
<span class="sourceLineNo">724</span>    public void uncheckedUpdateEntity(Entity par1Entity, boolean par2)<a name="line.724"></a>
<span class="sourceLineNo">725</span>    {<a name="line.725"></a>
<span class="sourceLineNo">726</span>        super.updateEntityWithOptionalForce(par1Entity, par2);<a name="line.726"></a>
<span class="sourceLineNo">727</span>    }<a name="line.727"></a>
<span class="sourceLineNo">728</span><a name="line.728"></a>
<span class="sourceLineNo">729</span>    /**<a name="line.729"></a>
<span class="sourceLineNo">730</span>     * Creates the chunk provider for this world. Called in the constructor. Retrieves provider from worldProvider?<a name="line.730"></a>
<span class="sourceLineNo">731</span>     */<a name="line.731"></a>
<span class="sourceLineNo">732</span>    protected IChunkProvider createChunkProvider()<a name="line.732"></a>
<span class="sourceLineNo">733</span>    {<a name="line.733"></a>
<span class="sourceLineNo">734</span>        IChunkLoader ichunkloader = this.saveHandler.getChunkLoader(this.provider);<a name="line.734"></a>
<span class="sourceLineNo">735</span>        this.theChunkProviderServer = new ChunkProviderServer(this, ichunkloader, this.provider.createChunkGenerator());<a name="line.735"></a>
<span class="sourceLineNo">736</span>        return this.theChunkProviderServer;<a name="line.736"></a>
<span class="sourceLineNo">737</span>    }<a name="line.737"></a>
<span class="sourceLineNo">738</span><a name="line.738"></a>
<span class="sourceLineNo">739</span>    /**<a name="line.739"></a>
<span class="sourceLineNo">740</span>     * pars: min x,y,z , max x,y,z<a name="line.740"></a>
<span class="sourceLineNo">741</span>     */<a name="line.741"></a>
<span class="sourceLineNo">742</span>    public List getAllTileEntityInBox(int par1, int par2, int par3, int par4, int par5, int par6)<a name="line.742"></a>
<span class="sourceLineNo">743</span>    {<a name="line.743"></a>
<span class="sourceLineNo">744</span>        ArrayList arraylist = new ArrayList();<a name="line.744"></a>
<span class="sourceLineNo">745</span><a name="line.745"></a>
<span class="sourceLineNo">746</span>        for(int x = (par1 &gt;&gt; 4); x &lt;= (par4 &gt;&gt; 4); x++)<a name="line.746"></a>
<span class="sourceLineNo">747</span>        {<a name="line.747"></a>
<span class="sourceLineNo">748</span>            for(int z = (par3 &gt;&gt; 4); z &lt;= (par6 &gt;&gt; 4); z++)<a name="line.748"></a>
<span class="sourceLineNo">749</span>            {<a name="line.749"></a>
<span class="sourceLineNo">750</span>                Chunk chunk = getChunkFromChunkCoords(x, z);<a name="line.750"></a>
<span class="sourceLineNo">751</span>                if (chunk != null)<a name="line.751"></a>
<span class="sourceLineNo">752</span>                {<a name="line.752"></a>
<span class="sourceLineNo">753</span>                    for(Object obj : chunk.chunkTileEntityMap.values())<a name="line.753"></a>
<span class="sourceLineNo">754</span>                    {<a name="line.754"></a>
<span class="sourceLineNo">755</span>                        TileEntity entity = (TileEntity)obj;<a name="line.755"></a>
<span class="sourceLineNo">756</span>                        if (!entity.isInvalid())<a name="line.756"></a>
<span class="sourceLineNo">757</span>                        {<a name="line.757"></a>
<span class="sourceLineNo">758</span>                            if (entity.xCoord &gt;= par1 &amp;&amp; entity.yCoord &gt;= par2 &amp;&amp; entity.zCoord &gt;= par3 &amp;&amp;<a name="line.758"></a>
<span class="sourceLineNo">759</span>                                entity.xCoord &lt;= par4 &amp;&amp; entity.yCoord &lt;= par5 &amp;&amp; entity.zCoord &lt;= par6)<a name="line.759"></a>
<span class="sourceLineNo">760</span>                            {<a name="line.760"></a>
<span class="sourceLineNo">761</span>                                arraylist.add(entity);<a name="line.761"></a>
<span class="sourceLineNo">762</span>                            }<a name="line.762"></a>
<span class="sourceLineNo">763</span>                        }<a name="line.763"></a>
<span class="sourceLineNo">764</span>                    }<a name="line.764"></a>
<span class="sourceLineNo">765</span>                }<a name="line.765"></a>
<span class="sourceLineNo">766</span>            }<a name="line.766"></a>
<span class="sourceLineNo">767</span>        }<a name="line.767"></a>
<span class="sourceLineNo">768</span>        return arraylist;<a name="line.768"></a>
<span class="sourceLineNo">769</span>    }<a name="line.769"></a>
<span class="sourceLineNo">770</span><a name="line.770"></a>
<span class="sourceLineNo">771</span>    /**<a name="line.771"></a>
<span class="sourceLineNo">772</span>     * Called when checking if a certain block can be mined or not. The 'spawn safe zone' check is located here.<a name="line.772"></a>
<span class="sourceLineNo">773</span>     */<a name="line.773"></a>
<span class="sourceLineNo">774</span>    public boolean canMineBlock(EntityPlayer par1EntityPlayer, int par2, int par3, int par4)<a name="line.774"></a>
<span class="sourceLineNo">775</span>    {<a name="line.775"></a>
<span class="sourceLineNo">776</span>        return super.canMineBlock(par1EntityPlayer, par2, par3, par4);<a name="line.776"></a>
<span class="sourceLineNo">777</span>    }<a name="line.777"></a>
<span class="sourceLineNo">778</span><a name="line.778"></a>
<span class="sourceLineNo">779</span>    public boolean canMineBlockBody(EntityPlayer par1EntityPlayer, int par2, int par3, int par4)<a name="line.779"></a>
<span class="sourceLineNo">780</span>    {<a name="line.780"></a>
<span class="sourceLineNo">781</span>        return !this.mcServer.func_96290_a(this, par2, par3, par4, par1EntityPlayer);<a name="line.781"></a>
<span class="sourceLineNo">782</span>    }<a name="line.782"></a>
<span class="sourceLineNo">783</span><a name="line.783"></a>
<span class="sourceLineNo">784</span>    protected void initialize(WorldSettings par1WorldSettings)<a name="line.784"></a>
<span class="sourceLineNo">785</span>    {<a name="line.785"></a>
<span class="sourceLineNo">786</span>        if (this.entityIdMap == null)<a name="line.786"></a>
<span class="sourceLineNo">787</span>        {<a name="line.787"></a>
<span class="sourceLineNo">788</span>            this.entityIdMap = new IntHashMap();<a name="line.788"></a>
<span class="sourceLineNo">789</span>        }<a name="line.789"></a>
<span class="sourceLineNo">790</span><a name="line.790"></a>
<span class="sourceLineNo">791</span>        if (this.field_73064_N == null)<a name="line.791"></a>
<span class="sourceLineNo">792</span>        {<a name="line.792"></a>
<span class="sourceLineNo">793</span>            this.field_73064_N = new HashSet();<a name="line.793"></a>
<span class="sourceLineNo">794</span>        }<a name="line.794"></a>
<span class="sourceLineNo">795</span><a name="line.795"></a>
<span class="sourceLineNo">796</span>        if (this.pendingTickListEntries == null)<a name="line.796"></a>
<span class="sourceLineNo">797</span>        {<a name="line.797"></a>
<span class="sourceLineNo">798</span>            this.pendingTickListEntries = new TreeSet();<a name="line.798"></a>
<span class="sourceLineNo">799</span>        }<a name="line.799"></a>
<span class="sourceLineNo">800</span><a name="line.800"></a>
<span class="sourceLineNo">801</span>        this.createSpawnPosition(par1WorldSettings);<a name="line.801"></a>
<span class="sourceLineNo">802</span>        super.initialize(par1WorldSettings);<a name="line.802"></a>
<span class="sourceLineNo">803</span>    }<a name="line.803"></a>
<span class="sourceLineNo">804</span><a name="line.804"></a>
<span class="sourceLineNo">805</span>    /**<a name="line.805"></a>
<span class="sourceLineNo">806</span>     * creates a spawn position at random within 256 blocks of 0,0<a name="line.806"></a>
<span class="sourceLineNo">807</span>     */<a name="line.807"></a>
<span class="sourceLineNo">808</span>    protected void createSpawnPosition(WorldSettings par1WorldSettings)<a name="line.808"></a>
<span class="sourceLineNo">809</span>    {<a name="line.809"></a>
<span class="sourceLineNo">810</span>        if (!this.provider.canRespawnHere())<a name="line.810"></a>
<span class="sourceLineNo">811</span>        {<a name="line.811"></a>
<span class="sourceLineNo">812</span>            this.worldInfo.setSpawnPosition(0, this.provider.getAverageGroundLevel(), 0);<a name="line.812"></a>
<span class="sourceLineNo">813</span>        }<a name="line.813"></a>
<span class="sourceLineNo">814</span>        else<a name="line.814"></a>
<span class="sourceLineNo">815</span>        {<a name="line.815"></a>
<span class="sourceLineNo">816</span>            this.findingSpawnPoint = true;<a name="line.816"></a>
<span class="sourceLineNo">817</span>            WorldChunkManager worldchunkmanager = this.provider.worldChunkMgr;<a name="line.817"></a>
<span class="sourceLineNo">818</span>            List list = worldchunkmanager.getBiomesToSpawnIn();<a name="line.818"></a>
<span class="sourceLineNo">819</span>            Random random = new Random(this.getSeed());<a name="line.819"></a>
<span class="sourceLineNo">820</span>            ChunkPosition chunkposition = worldchunkmanager.findBiomePosition(0, 0, 256, list, random);<a name="line.820"></a>
<span class="sourceLineNo">821</span>            int i = 0;<a name="line.821"></a>
<span class="sourceLineNo">822</span>            int j = this.provider.getAverageGroundLevel();<a name="line.822"></a>
<span class="sourceLineNo">823</span>            int k = 0;<a name="line.823"></a>
<span class="sourceLineNo">824</span><a name="line.824"></a>
<span class="sourceLineNo">825</span>            if (chunkposition != null)<a name="line.825"></a>
<span class="sourceLineNo">826</span>            {<a name="line.826"></a>
<span class="sourceLineNo">827</span>                i = chunkposition.x;<a name="line.827"></a>
<span class="sourceLineNo">828</span>                k = chunkposition.z;<a name="line.828"></a>
<span class="sourceLineNo">829</span>            }<a name="line.829"></a>
<span class="sourceLineNo">830</span>            else<a name="line.830"></a>
<span class="sourceLineNo">831</span>            {<a name="line.831"></a>
<span class="sourceLineNo">832</span>                this.getWorldLogAgent().logWarning("Unable to find spawn biome");<a name="line.832"></a>
<span class="sourceLineNo">833</span>            }<a name="line.833"></a>
<span class="sourceLineNo">834</span><a name="line.834"></a>
<span class="sourceLineNo">835</span>            int l = 0;<a name="line.835"></a>
<span class="sourceLineNo">836</span><a name="line.836"></a>
<span class="sourceLineNo">837</span>            while (!this.provider.canCoordinateBeSpawn(i, k))<a name="line.837"></a>
<span class="sourceLineNo">838</span>            {<a name="line.838"></a>
<span class="sourceLineNo">839</span>                i += random.nextInt(64) - random.nextInt(64);<a name="line.839"></a>
<span class="sourceLineNo">840</span>                k += random.nextInt(64) - random.nextInt(64);<a name="line.840"></a>
<span class="sourceLineNo">841</span>                ++l;<a name="line.841"></a>
<span class="sourceLineNo">842</span><a name="line.842"></a>
<span class="sourceLineNo">843</span>                if (l == 1000)<a name="line.843"></a>
<span class="sourceLineNo">844</span>                {<a name="line.844"></a>
<span class="sourceLineNo">845</span>                    break;<a name="line.845"></a>
<span class="sourceLineNo">846</span>                }<a name="line.846"></a>
<span class="sourceLineNo">847</span>            }<a name="line.847"></a>
<span class="sourceLineNo">848</span><a name="line.848"></a>
<span class="sourceLineNo">849</span>            this.worldInfo.setSpawnPosition(i, j, k);<a name="line.849"></a>
<span class="sourceLineNo">850</span>            this.findingSpawnPoint = false;<a name="line.850"></a>
<span class="sourceLineNo">851</span><a name="line.851"></a>
<span class="sourceLineNo">852</span>            if (par1WorldSettings.isBonusChestEnabled())<a name="line.852"></a>
<span class="sourceLineNo">853</span>            {<a name="line.853"></a>
<span class="sourceLineNo">854</span>                this.createBonusChest();<a name="line.854"></a>
<span class="sourceLineNo">855</span>            }<a name="line.855"></a>
<span class="sourceLineNo">856</span>        }<a name="line.856"></a>
<span class="sourceLineNo">857</span>    }<a name="line.857"></a>
<span class="sourceLineNo">858</span><a name="line.858"></a>
<span class="sourceLineNo">859</span>    /**<a name="line.859"></a>
<span class="sourceLineNo">860</span>     * Creates the bonus chest in the world.<a name="line.860"></a>
<span class="sourceLineNo">861</span>     */<a name="line.861"></a>
<span class="sourceLineNo">862</span>    protected void createBonusChest()<a name="line.862"></a>
<span class="sourceLineNo">863</span>    {<a name="line.863"></a>
<span class="sourceLineNo">864</span>        WorldGeneratorBonusChest worldgeneratorbonuschest = new WorldGeneratorBonusChest(ChestGenHooks.getItems(BONUS_CHEST, rand), ChestGenHooks.getCount(BONUS_CHEST, rand));<a name="line.864"></a>
<span class="sourceLineNo">865</span><a name="line.865"></a>
<span class="sourceLineNo">866</span>        for (int i = 0; i &lt; 10; ++i)<a name="line.866"></a>
<span class="sourceLineNo">867</span>        {<a name="line.867"></a>
<span class="sourceLineNo">868</span>            int j = this.worldInfo.getSpawnX() + this.rand.nextInt(6) - this.rand.nextInt(6);<a name="line.868"></a>
<span class="sourceLineNo">869</span>            int k = this.worldInfo.getSpawnZ() + this.rand.nextInt(6) - this.rand.nextInt(6);<a name="line.869"></a>
<span class="sourceLineNo">870</span>            int l = this.getTopSolidOrLiquidBlock(j, k) + 1;<a name="line.870"></a>
<span class="sourceLineNo">871</span><a name="line.871"></a>
<span class="sourceLineNo">872</span>            if (worldgeneratorbonuschest.generate(this, this.rand, j, l, k))<a name="line.872"></a>
<span class="sourceLineNo">873</span>            {<a name="line.873"></a>
<span class="sourceLineNo">874</span>                break;<a name="line.874"></a>
<span class="sourceLineNo">875</span>            }<a name="line.875"></a>
<span class="sourceLineNo">876</span>        }<a name="line.876"></a>
<span class="sourceLineNo">877</span>    }<a name="line.877"></a>
<span class="sourceLineNo">878</span><a name="line.878"></a>
<span class="sourceLineNo">879</span>    /**<a name="line.879"></a>
<span class="sourceLineNo">880</span>     * Gets the hard-coded portal location to use when entering this dimension.<a name="line.880"></a>
<span class="sourceLineNo">881</span>     */<a name="line.881"></a>
<span class="sourceLineNo">882</span>    public ChunkCoordinates getEntrancePortalLocation()<a name="line.882"></a>
<span class="sourceLineNo">883</span>    {<a name="line.883"></a>
<span class="sourceLineNo">884</span>        return this.provider.getEntrancePortalLocation();<a name="line.884"></a>
<span class="sourceLineNo">885</span>    }<a name="line.885"></a>
<span class="sourceLineNo">886</span><a name="line.886"></a>
<span class="sourceLineNo">887</span>    /**<a name="line.887"></a>
<span class="sourceLineNo">888</span>     * Saves all chunks to disk while updating progress bar.<a name="line.888"></a>
<span class="sourceLineNo">889</span>     */<a name="line.889"></a>
<span class="sourceLineNo">890</span>    public void saveAllChunks(boolean par1, IProgressUpdate par2IProgressUpdate) throws MinecraftException<a name="line.890"></a>
<span class="sourceLineNo">891</span>    {<a name="line.891"></a>
<span class="sourceLineNo">892</span>        if (this.chunkProvider.canSave())<a name="line.892"></a>
<span class="sourceLineNo">893</span>        {<a name="line.893"></a>
<span class="sourceLineNo">894</span>            if (par2IProgressUpdate != null)<a name="line.894"></a>
<span class="sourceLineNo">895</span>            {<a name="line.895"></a>
<span class="sourceLineNo">896</span>                par2IProgressUpdate.displayProgressMessage("Saving level");<a name="line.896"></a>
<span class="sourceLineNo">897</span>            }<a name="line.897"></a>
<span class="sourceLineNo">898</span><a name="line.898"></a>
<span class="sourceLineNo">899</span>            this.saveLevel();<a name="line.899"></a>
<span class="sourceLineNo">900</span><a name="line.900"></a>
<span class="sourceLineNo">901</span>            if (par2IProgressUpdate != null)<a name="line.901"></a>
<span class="sourceLineNo">902</span>            {<a name="line.902"></a>
<span class="sourceLineNo">903</span>                par2IProgressUpdate.resetProgresAndWorkingMessage("Saving chunks");<a name="line.903"></a>
<span class="sourceLineNo">904</span>            }<a name="line.904"></a>
<span class="sourceLineNo">905</span><a name="line.905"></a>
<span class="sourceLineNo">906</span>            this.chunkProvider.saveChunks(par1, par2IProgressUpdate);<a name="line.906"></a>
<span class="sourceLineNo">907</span>            MinecraftForge.EVENT_BUS.post(new WorldEvent.Save(this));<a name="line.907"></a>
<span class="sourceLineNo">908</span>        }<a name="line.908"></a>
<span class="sourceLineNo">909</span>    }<a name="line.909"></a>
<span class="sourceLineNo">910</span><a name="line.910"></a>
<span class="sourceLineNo">911</span>    /**<a name="line.911"></a>
<span class="sourceLineNo">912</span>     * Saves the chunks to disk.<a name="line.912"></a>
<span class="sourceLineNo">913</span>     */<a name="line.913"></a>
<span class="sourceLineNo">914</span>    protected void saveLevel() throws MinecraftException<a name="line.914"></a>
<span class="sourceLineNo">915</span>    {<a name="line.915"></a>
<span class="sourceLineNo">916</span>        this.checkSessionLock();<a name="line.916"></a>
<span class="sourceLineNo">917</span>        this.saveHandler.saveWorldInfoWithPlayer(this.worldInfo, this.mcServer.getConfigurationManager().getHostPlayerData());<a name="line.917"></a>
<span class="sourceLineNo">918</span>        this.mapStorage.saveAllData();<a name="line.918"></a>
<span class="sourceLineNo">919</span>        this.perWorldStorage.saveAllData();<a name="line.919"></a>
<span class="sourceLineNo">920</span>    }<a name="line.920"></a>
<span class="sourceLineNo">921</span><a name="line.921"></a>
<span class="sourceLineNo">922</span>    /**<a name="line.922"></a>
<span class="sourceLineNo">923</span>     * Start the skin for this entity downloading, if necessary, and increment its reference counter<a name="line.923"></a>
<span class="sourceLineNo">924</span>     */<a name="line.924"></a>
<span class="sourceLineNo">925</span>    protected void obtainEntitySkin(Entity par1Entity)<a name="line.925"></a>
<span class="sourceLineNo">926</span>    {<a name="line.926"></a>
<span class="sourceLineNo">927</span>        super.obtainEntitySkin(par1Entity);<a name="line.927"></a>
<span class="sourceLineNo">928</span>        this.entityIdMap.addKey(par1Entity.entityId, par1Entity);<a name="line.928"></a>
<span class="sourceLineNo">929</span>        Entity[] aentity = par1Entity.getParts();<a name="line.929"></a>
<span class="sourceLineNo">930</span><a name="line.930"></a>
<span class="sourceLineNo">931</span>        if (aentity != null)<a name="line.931"></a>
<span class="sourceLineNo">932</span>        {<a name="line.932"></a>
<span class="sourceLineNo">933</span>            for (int i = 0; i &lt; aentity.length; ++i)<a name="line.933"></a>
<span class="sourceLineNo">934</span>            {<a name="line.934"></a>
<span class="sourceLineNo">935</span>                this.entityIdMap.addKey(aentity[i].entityId, aentity[i]);<a name="line.935"></a>
<span class="sourceLineNo">936</span>            }<a name="line.936"></a>
<span class="sourceLineNo">937</span>        }<a name="line.937"></a>
<span class="sourceLineNo">938</span>    }<a name="line.938"></a>
<span class="sourceLineNo">939</span><a name="line.939"></a>
<span class="sourceLineNo">940</span>    /**<a name="line.940"></a>
<span class="sourceLineNo">941</span>     * Decrement the reference counter for this entity's skin image data<a name="line.941"></a>
<span class="sourceLineNo">942</span>     */<a name="line.942"></a>
<span class="sourceLineNo">943</span>    public void releaseEntitySkin(Entity par1Entity)<a name="line.943"></a>
<span class="sourceLineNo">944</span>    {<a name="line.944"></a>
<span class="sourceLineNo">945</span>        super.releaseEntitySkin(par1Entity);<a name="line.945"></a>
<span class="sourceLineNo">946</span>        this.entityIdMap.removeObject(par1Entity.entityId);<a name="line.946"></a>
<span class="sourceLineNo">947</span>        Entity[] aentity = par1Entity.getParts();<a name="line.947"></a>
<span class="sourceLineNo">948</span><a name="line.948"></a>
<span class="sourceLineNo">949</span>        if (aentity != null)<a name="line.949"></a>
<span class="sourceLineNo">950</span>        {<a name="line.950"></a>
<span class="sourceLineNo">951</span>            for (int i = 0; i &lt; aentity.length; ++i)<a name="line.951"></a>
<span class="sourceLineNo">952</span>            {<a name="line.952"></a>
<span class="sourceLineNo">953</span>                this.entityIdMap.removeObject(aentity[i].entityId);<a name="line.953"></a>
<span class="sourceLineNo">954</span>            }<a name="line.954"></a>
<span class="sourceLineNo">955</span>        }<a name="line.955"></a>
<span class="sourceLineNo">956</span>    }<a name="line.956"></a>
<span class="sourceLineNo">957</span><a name="line.957"></a>
<span class="sourceLineNo">958</span>    /**<a name="line.958"></a>
<span class="sourceLineNo">959</span>     * Returns the Entity with the given ID, or null if it doesn't exist in this World.<a name="line.959"></a>
<span class="sourceLineNo">960</span>     */<a name="line.960"></a>
<span class="sourceLineNo">961</span>    public Entity getEntityByID(int par1)<a name="line.961"></a>
<span class="sourceLineNo">962</span>    {<a name="line.962"></a>
<span class="sourceLineNo">963</span>        return (Entity)this.entityIdMap.lookup(par1);<a name="line.963"></a>
<span class="sourceLineNo">964</span>    }<a name="line.964"></a>
<span class="sourceLineNo">965</span><a name="line.965"></a>
<span class="sourceLineNo">966</span>    /**<a name="line.966"></a>
<span class="sourceLineNo">967</span>     * adds a lightning bolt to the list of lightning bolts in this world.<a name="line.967"></a>
<span class="sourceLineNo">968</span>     */<a name="line.968"></a>
<span class="sourceLineNo">969</span>    public boolean addWeatherEffect(Entity par1Entity)<a name="line.969"></a>
<span class="sourceLineNo">970</span>    {<a name="line.970"></a>
<span class="sourceLineNo">971</span>        if (super.addWeatherEffect(par1Entity))<a name="line.971"></a>
<span class="sourceLineNo">972</span>        {<a name="line.972"></a>
<span class="sourceLineNo">973</span>            this.mcServer.getConfigurationManager().sendToAllNear(par1Entity.posX, par1Entity.posY, par1Entity.posZ, 512.0D, this.provider.dimensionId, new Packet71Weather(par1Entity));<a name="line.973"></a>
<span class="sourceLineNo">974</span>            return true;<a name="line.974"></a>
<span class="sourceLineNo">975</span>        }<a name="line.975"></a>
<span class="sourceLineNo">976</span>        else<a name="line.976"></a>
<span class="sourceLineNo">977</span>        {<a name="line.977"></a>
<span class="sourceLineNo">978</span>            return false;<a name="line.978"></a>
<span class="sourceLineNo">979</span>        }<a name="line.979"></a>
<span class="sourceLineNo">980</span>    }<a name="line.980"></a>
<span class="sourceLineNo">981</span><a name="line.981"></a>
<span class="sourceLineNo">982</span>    /**<a name="line.982"></a>
<span class="sourceLineNo">983</span>     * sends a Packet 38 (Entity Status) to all tracked players of that entity<a name="line.983"></a>
<span class="sourceLineNo">984</span>     */<a name="line.984"></a>
<span class="sourceLineNo">985</span>    public void setEntityState(Entity par1Entity, byte par2)<a name="line.985"></a>
<span class="sourceLineNo">986</span>    {<a name="line.986"></a>
<span class="sourceLineNo">987</span>        Packet38EntityStatus packet38entitystatus = new Packet38EntityStatus(par1Entity.entityId, par2);<a name="line.987"></a>
<span class="sourceLineNo">988</span>        this.getEntityTracker().sendPacketToAllAssociatedPlayers(par1Entity, packet38entitystatus);<a name="line.988"></a>
<span class="sourceLineNo">989</span>    }<a name="line.989"></a>
<span class="sourceLineNo">990</span><a name="line.990"></a>
<span class="sourceLineNo">991</span>    /**<a name="line.991"></a>
<span class="sourceLineNo">992</span>     * returns a new explosion. Does initiation (at time of writing Explosion is not finished)<a name="line.992"></a>
<span class="sourceLineNo">993</span>     */<a name="line.993"></a>
<span class="sourceLineNo">994</span>    public Explosion newExplosion(Entity par1Entity, double par2, double par4, double par6, float par8, boolean par9, boolean par10)<a name="line.994"></a>
<span class="sourceLineNo">995</span>    {<a name="line.995"></a>
<span class="sourceLineNo">996</span>        Explosion explosion = new Explosion(this, par1Entity, par2, par4, par6, par8);<a name="line.996"></a>
<span class="sourceLineNo">997</span>        explosion.isFlaming = par9;<a name="line.997"></a>
<span class="sourceLineNo">998</span>        explosion.isSmoking = par10;<a name="line.998"></a>
<span class="sourceLineNo">999</span>        explosion.doExplosionA();<a name="line.999"></a>
<span class="sourceLineNo">1000</span>        explosion.doExplosionB(false);<a name="line.1000"></a>
<span class="sourceLineNo">1001</span><a name="line.1001"></a>
<span class="sourceLineNo">1002</span>        if (!par10)<a name="line.1002"></a>
<span class="sourceLineNo">1003</span>        {<a name="line.1003"></a>
<span class="sourceLineNo">1004</span>            explosion.affectedBlockPositions.clear();<a name="line.1004"></a>
<span class="sourceLineNo">1005</span>        }<a name="line.1005"></a>
<span class="sourceLineNo">1006</span><a name="line.1006"></a>
<span class="sourceLineNo">1007</span>        Iterator iterator = this.playerEntities.iterator();<a name="line.1007"></a>
<span class="sourceLineNo">1008</span><a name="line.1008"></a>
<span class="sourceLineNo">1009</span>        while (iterator.hasNext())<a name="line.1009"></a>
<span class="sourceLineNo">1010</span>        {<a name="line.1010"></a>
<span class="sourceLineNo">1011</span>            EntityPlayer entityplayer = (EntityPlayer)iterator.next();<a name="line.1011"></a>
<span class="sourceLineNo">1012</span><a name="line.1012"></a>
<span class="sourceLineNo">1013</span>            if (entityplayer.getDistanceSq(par2, par4, par6) &lt; 4096.0D)<a name="line.1013"></a>
<span class="sourceLineNo">1014</span>            {<a name="line.1014"></a>
<span class="sourceLineNo">1015</span>                ((EntityPlayerMP)entityplayer).playerNetServerHandler.sendPacketToPlayer(new Packet60Explosion(par2, par4, par6, par8, explosion.affectedBlockPositions, (Vec3)explosion.func_77277_b().get(entityplayer)));<a name="line.1015"></a>
<span class="sourceLineNo">1016</span>            }<a name="line.1016"></a>
<span class="sourceLineNo">1017</span>        }<a name="line.1017"></a>
<span class="sourceLineNo">1018</span><a name="line.1018"></a>
<span class="sourceLineNo">1019</span>        return explosion;<a name="line.1019"></a>
<span class="sourceLineNo">1020</span>    }<a name="line.1020"></a>
<span class="sourceLineNo">1021</span><a name="line.1021"></a>
<span class="sourceLineNo">1022</span>    /**<a name="line.1022"></a>
<span class="sourceLineNo">1023</span>     * Adds a block event with the given Args to the blockEventCache. During the next tick(), the block specified will<a name="line.1023"></a>
<span class="sourceLineNo">1024</span>     * have its onBlockEvent handler called with the given parameters. Args: X,Y,Z, BlockID, EventID, EventParameter<a name="line.1024"></a>
<span class="sourceLineNo">1025</span>     */<a name="line.1025"></a>
<span class="sourceLineNo">1026</span>    public void addBlockEvent(int par1, int par2, int par3, int par4, int par5, int par6)<a name="line.1026"></a>
<span class="sourceLineNo">1027</span>    {<a name="line.1027"></a>
<span class="sourceLineNo">1028</span>        BlockEventData blockeventdata = new BlockEventData(par1, par2, par3, par4, par5, par6);<a name="line.1028"></a>
<span class="sourceLineNo">1029</span>        Iterator iterator = this.blockEventCache[this.blockEventCacheIndex].iterator();<a name="line.1029"></a>
<span class="sourceLineNo">1030</span>        BlockEventData blockeventdata1;<a name="line.1030"></a>
<span class="sourceLineNo">1031</span><a name="line.1031"></a>
<span class="sourceLineNo">1032</span>        do<a name="line.1032"></a>
<span class="sourceLineNo">1033</span>        {<a name="line.1033"></a>
<span class="sourceLineNo">1034</span>            if (!iterator.hasNext())<a name="line.1034"></a>
<span class="sourceLineNo">1035</span>            {<a name="line.1035"></a>
<span class="sourceLineNo">1036</span>                this.blockEventCache[this.blockEventCacheIndex].add(blockeventdata);<a name="line.1036"></a>
<span class="sourceLineNo">1037</span>                return;<a name="line.1037"></a>
<span class="sourceLineNo">1038</span>            }<a name="line.1038"></a>
<span class="sourceLineNo">1039</span><a name="line.1039"></a>
<span class="sourceLineNo">1040</span>            blockeventdata1 = (BlockEventData)iterator.next();<a name="line.1040"></a>
<span class="sourceLineNo">1041</span>        }<a name="line.1041"></a>
<span class="sourceLineNo">1042</span>        while (!blockeventdata1.equals(blockeventdata));<a name="line.1042"></a>
<span class="sourceLineNo">1043</span>    }<a name="line.1043"></a>
<span class="sourceLineNo">1044</span><a name="line.1044"></a>
<span class="sourceLineNo">1045</span>    /**<a name="line.1045"></a>
<span class="sourceLineNo">1046</span>     * Send and apply locally all pending BlockEvents to each player with 64m radius of the event.<a name="line.1046"></a>
<span class="sourceLineNo">1047</span>     */<a name="line.1047"></a>
<span class="sourceLineNo">1048</span>    private void sendAndApplyBlockEvents()<a name="line.1048"></a>
<span class="sourceLineNo">1049</span>    {<a name="line.1049"></a>
<span class="sourceLineNo">1050</span>        while (!this.blockEventCache[this.blockEventCacheIndex].isEmpty())<a name="line.1050"></a>
<span class="sourceLineNo">1051</span>        {<a name="line.1051"></a>
<span class="sourceLineNo">1052</span>            int i = this.blockEventCacheIndex;<a name="line.1052"></a>
<span class="sourceLineNo">1053</span>            this.blockEventCacheIndex ^= 1;<a name="line.1053"></a>
<span class="sourceLineNo">1054</span>            Iterator iterator = this.blockEventCache[i].iterator();<a name="line.1054"></a>
<span class="sourceLineNo">1055</span><a name="line.1055"></a>
<span class="sourceLineNo">1056</span>            while (iterator.hasNext())<a name="line.1056"></a>
<span class="sourceLineNo">1057</span>            {<a name="line.1057"></a>
<span class="sourceLineNo">1058</span>                BlockEventData blockeventdata = (BlockEventData)iterator.next();<a name="line.1058"></a>
<span class="sourceLineNo">1059</span><a name="line.1059"></a>
<span class="sourceLineNo">1060</span>                if (this.onBlockEventReceived(blockeventdata))<a name="line.1060"></a>
<span class="sourceLineNo">1061</span>                {<a name="line.1061"></a>
<span class="sourceLineNo">1062</span>                    this.mcServer.getConfigurationManager().sendToAllNear((double)blockeventdata.getX(), (double)blockeventdata.getY(), (double)blockeventdata.getZ(), 64.0D, this.provider.dimensionId, new Packet54PlayNoteBlock(blockeventdata.getX(), blockeventdata.getY(), blockeventdata.getZ(), blockeventdata.getBlockID(), blockeventdata.getEventID(), blockeventdata.getEventParameter()));<a name="line.1062"></a>
<span class="sourceLineNo">1063</span>                }<a name="line.1063"></a>
<span class="sourceLineNo">1064</span>            }<a name="line.1064"></a>
<span class="sourceLineNo">1065</span><a name="line.1065"></a>
<span class="sourceLineNo">1066</span>            this.blockEventCache[i].clear();<a name="line.1066"></a>
<span class="sourceLineNo">1067</span>        }<a name="line.1067"></a>
<span class="sourceLineNo">1068</span>    }<a name="line.1068"></a>
<span class="sourceLineNo">1069</span><a name="line.1069"></a>
<span class="sourceLineNo">1070</span>    /**<a name="line.1070"></a>
<span class="sourceLineNo">1071</span>     * Called to apply a pending BlockEvent to apply to the current world.<a name="line.1071"></a>
<span class="sourceLineNo">1072</span>     */<a name="line.1072"></a>
<span class="sourceLineNo">1073</span>    private boolean onBlockEventReceived(BlockEventData par1BlockEventData)<a name="line.1073"></a>
<span class="sourceLineNo">1074</span>    {<a name="line.1074"></a>
<span class="sourceLineNo">1075</span>        int i = this.getBlockId(par1BlockEventData.getX(), par1BlockEventData.getY(), par1BlockEventData.getZ());<a name="line.1075"></a>
<span class="sourceLineNo">1076</span>        return i == par1BlockEventData.getBlockID() ? Block.blocksList[i].onBlockEventReceived(this, par1BlockEventData.getX(), par1BlockEventData.getY(), par1BlockEventData.getZ(), par1BlockEventData.getEventID(), par1BlockEventData.getEventParameter()) : false;<a name="line.1076"></a>
<span class="sourceLineNo">1077</span>    }<a name="line.1077"></a>
<span class="sourceLineNo">1078</span><a name="line.1078"></a>
<span class="sourceLineNo">1079</span>    /**<a name="line.1079"></a>
<span class="sourceLineNo">1080</span>     * Syncs all changes to disk and wait for completion.<a name="line.1080"></a>
<span class="sourceLineNo">1081</span>     */<a name="line.1081"></a>
<span class="sourceLineNo">1082</span>    public void flush()<a name="line.1082"></a>
<span class="sourceLineNo">1083</span>    {<a name="line.1083"></a>
<span class="sourceLineNo">1084</span>        this.saveHandler.flush();<a name="line.1084"></a>
<span class="sourceLineNo">1085</span>    }<a name="line.1085"></a>
<span class="sourceLineNo">1086</span><a name="line.1086"></a>
<span class="sourceLineNo">1087</span>    /**<a name="line.1087"></a>
<span class="sourceLineNo">1088</span>     * Updates all weather states.<a name="line.1088"></a>
<span class="sourceLineNo">1089</span>     */<a name="line.1089"></a>
<span class="sourceLineNo">1090</span>    protected void updateWeather()<a name="line.1090"></a>
<span class="sourceLineNo">1091</span>    {<a name="line.1091"></a>
<span class="sourceLineNo">1092</span>        boolean flag = this.isRaining();<a name="line.1092"></a>
<span class="sourceLineNo">1093</span>        super.updateWeather();<a name="line.1093"></a>
<span class="sourceLineNo">1094</span><a name="line.1094"></a>
<span class="sourceLineNo">1095</span>        if (flag != this.isRaining())<a name="line.1095"></a>
<span class="sourceLineNo">1096</span>        {<a name="line.1096"></a>
<span class="sourceLineNo">1097</span>            if (flag)<a name="line.1097"></a>
<span class="sourceLineNo">1098</span>            {<a name="line.1098"></a>
<span class="sourceLineNo">1099</span>                this.mcServer.getConfigurationManager().sendPacketToAllPlayers(new Packet70GameEvent(2, 0));<a name="line.1099"></a>
<span class="sourceLineNo">1100</span>            }<a name="line.1100"></a>
<span class="sourceLineNo">1101</span>            else<a name="line.1101"></a>
<span class="sourceLineNo">1102</span>            {<a name="line.1102"></a>
<span class="sourceLineNo">1103</span>                this.mcServer.getConfigurationManager().sendPacketToAllPlayers(new Packet70GameEvent(1, 0));<a name="line.1103"></a>
<span class="sourceLineNo">1104</span>            }<a name="line.1104"></a>
<span class="sourceLineNo">1105</span>        }<a name="line.1105"></a>
<span class="sourceLineNo">1106</span>    }<a name="line.1106"></a>
<span class="sourceLineNo">1107</span><a name="line.1107"></a>
<span class="sourceLineNo">1108</span>    /**<a name="line.1108"></a>
<span class="sourceLineNo">1109</span>     * Gets the MinecraftServer.<a name="line.1109"></a>
<span class="sourceLineNo">1110</span>     */<a name="line.1110"></a>
<span class="sourceLineNo">1111</span>    public MinecraftServer getMinecraftServer()<a name="line.1111"></a>
<span class="sourceLineNo">1112</span>    {<a name="line.1112"></a>
<span class="sourceLineNo">1113</span>        return this.mcServer;<a name="line.1113"></a>
<span class="sourceLineNo">1114</span>    }<a name="line.1114"></a>
<span class="sourceLineNo">1115</span><a name="line.1115"></a>
<span class="sourceLineNo">1116</span>    /**<a name="line.1116"></a>
<span class="sourceLineNo">1117</span>     * Gets the EntityTracker<a name="line.1117"></a>
<span class="sourceLineNo">1118</span>     */<a name="line.1118"></a>
<span class="sourceLineNo">1119</span>    public EntityTracker getEntityTracker()<a name="line.1119"></a>
<span class="sourceLineNo">1120</span>    {<a name="line.1120"></a>
<span class="sourceLineNo">1121</span>        return this.theEntityTracker;<a name="line.1121"></a>
<span class="sourceLineNo">1122</span>    }<a name="line.1122"></a>
<span class="sourceLineNo">1123</span><a name="line.1123"></a>
<span class="sourceLineNo">1124</span>    public PlayerManager getPlayerManager()<a name="line.1124"></a>
<span class="sourceLineNo">1125</span>    {<a name="line.1125"></a>
<span class="sourceLineNo">1126</span>        return this.thePlayerManager;<a name="line.1126"></a>
<span class="sourceLineNo">1127</span>    }<a name="line.1127"></a>
<span class="sourceLineNo">1128</span><a name="line.1128"></a>
<span class="sourceLineNo">1129</span>    public Teleporter getDefaultTeleporter()<a name="line.1129"></a>
<span class="sourceLineNo">1130</span>    {<a name="line.1130"></a>
<span class="sourceLineNo">1131</span>        return this.field_85177_Q;<a name="line.1131"></a>
<span class="sourceLineNo">1132</span>    }<a name="line.1132"></a>
<span class="sourceLineNo">1133</span><a name="line.1133"></a>
<span class="sourceLineNo">1134</span>    public File getChunkSaveLocation()<a name="line.1134"></a>
<span class="sourceLineNo">1135</span>    {<a name="line.1135"></a>
<span class="sourceLineNo">1136</span>        return ((AnvilChunkLoader)theChunkProviderServer.currentChunkLoader).chunkSaveLocation;<a name="line.1136"></a>
<span class="sourceLineNo">1137</span>    }<a name="line.1137"></a>
<span class="sourceLineNo">1138</span>}<a name="line.1138"></a>




























































</pre>
</div>
</body>
</html>
